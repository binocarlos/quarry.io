var require=function(file,cwd){var resolved=require.resolve(file,cwd||"/");var mod=require.modules[resolved];if(!mod)throw new Error("Failed to resolve module "+file+", tried "+resolved);var cached=require.cache[resolved];var res=cached?cached.exports:mod();return res};require.paths=[];require.modules={};require.cache={};require.extensions=[".js",".coffee",".json"];require._core={assert:true,events:true,fs:true,path:true,vm:true};require.resolve=function(){return function(x,cwd){if(!cwd)cwd="/";if(require._core[x])return x;var path=require.modules.path();cwd=path.resolve("/",cwd);var y=cwd||"/";if(x.match(/^(?:\.\.?\/|\/)/)){var m=loadAsFileSync(path.resolve(y,x))||loadAsDirectorySync(path.resolve(y,x));if(m)return m}var n=loadNodeModulesSync(x,y);if(n)return n;throw new Error("Cannot find module '"+x+"'");function loadAsFileSync(x){x=path.normalize(x);if(require.modules[x]){return x}for(var i=0;i<require.extensions.length;i++){var ext=require.extensions[i];if(require.modules[x+ext])return x+ext}}function loadAsDirectorySync(x){x=x.replace(/\/+$/,"");var pkgfile=path.normalize(x+"/package.json");if(require.modules[pkgfile]){var pkg=require.modules[pkgfile]();var b=pkg.browserify;if(typeof b==="object"&&b.main){var m=loadAsFileSync(path.resolve(x,b.main));if(m)return m}else if(typeof b==="string"){var m=loadAsFileSync(path.resolve(x,b));if(m)return m}else if(pkg.main){var m=loadAsFileSync(path.resolve(x,pkg.main));if(m)return m}}return loadAsFileSync(x+"/index")}function loadNodeModulesSync(x,start){var dirs=nodeModulesPathsSync(start);for(var i=0;i<dirs.length;i++){var dir=dirs[i];var m=loadAsFileSync(dir+"/"+x);if(m)return m;var n=loadAsDirectorySync(dir+"/"+x);if(n)return n}var m=loadAsFileSync(x);if(m)return m}function nodeModulesPathsSync(start){var parts;if(start==="/")parts=[""];else parts=path.normalize(start).split("/");var dirs=[];for(var i=parts.length-1;i>=0;i--){if(parts[i]==="node_modules")continue;var dir=parts.slice(0,i+1).join("/")+"/node_modules";dirs.push(dir)}return dirs}}}();require.alias=function(from,to){var path=require.modules.path();var res=null;try{res=require.resolve(from+"/package.json","/")}catch(err){res=require.resolve(from,"/")}var basedir=path.dirname(res);var keys=(Object.keys||function(obj){var res=[];for(var key in obj)res.push(key);return res})(require.modules);for(var i=0;i<keys.length;i++){var key=keys[i];if(key.slice(0,basedir.length+1)===basedir+"/"){var f=key.slice(basedir.length);require.modules[to+f]=require.modules[basedir+f]}else if(key===basedir){require.modules[to]=require.modules[basedir]}}};(function(){var process={};var global=typeof window!=="undefined"?window:{};var definedProcess=false;require.define=function(filename,fn){if(!definedProcess&&require.modules.__browserify_process){process=require.modules.__browserify_process();definedProcess=true}var dirname=require._core[filename]?"":require.modules.path().dirname(filename);var require_=function(file){var requiredModule=require(file,dirname);var cached=require.cache[require.resolve(file,dirname)];if(cached&&cached.parent===null){cached.parent=module_}return requiredModule};require_.resolve=function(name){return require.resolve(name,dirname)};require_.modules=require.modules;require_.define=require.define;require_.cache=require.cache;var module_={id:filename,filename:filename,exports:{},loaded:false,parent:null};require.modules[filename]=function(){require.cache[filename]=module_;fn.call(module_.exports,require_,module_,module_.exports,dirname,filename,process,global);module_.loaded=true;return module_.exports}}})();require.define("path",function(require,module,exports,__dirname,__filename,process,global){function filter(xs,fn){var res=[];for(var i=0;i<xs.length;i++){if(fn(xs[i],i,xs))res.push(xs[i])}return res}function normalizeArray(parts,allowAboveRoot){var up=0;for(var i=parts.length;i>=0;i--){var last=parts[i];if(last=="."){parts.splice(i,1)}else if(last===".."){parts.splice(i,1);up++}else if(up){parts.splice(i,1);up--}}if(allowAboveRoot){for(;up--;up){parts.unshift("..")}}return parts}var splitPathRe=/^(.+\/(?!$)|\/)?((?:.+?)?(\.[^.]*)?)$/;exports.resolve=function(){var resolvedPath="",resolvedAbsolute=false;for(var i=arguments.length;i>=-1&&!resolvedAbsolute;i--){var path=i>=0?arguments[i]:process.cwd();if(typeof path!=="string"||!path){continue}resolvedPath=path+"/"+resolvedPath;resolvedAbsolute=path.charAt(0)==="/"}resolvedPath=normalizeArray(filter(resolvedPath.split("/"),function(p){return!!p}),!resolvedAbsolute).join("/");return(resolvedAbsolute?"/":"")+resolvedPath||"."};exports.normalize=function(path){var isAbsolute=path.charAt(0)==="/",trailingSlash=path.slice(-1)==="/";path=normalizeArray(filter(path.split("/"),function(p){return!!p}),!isAbsolute).join("/");if(!path&&!isAbsolute){path="."}if(path&&trailingSlash){path+="/"}return(isAbsolute?"/":"")+path};exports.join=function(){var paths=Array.prototype.slice.call(arguments,0);return exports.normalize(filter(paths,function(p,index){return p&&typeof p==="string"}).join("/"))};exports.dirname=function(path){var dir=splitPathRe.exec(path)[1]||"";var isWindows=false;if(!dir){return"."}else if(dir.length===1||isWindows&&dir.length<=3&&dir.charAt(1)===":"){return dir}else{return dir.substring(0,dir.length-1)}};exports.basename=function(path,ext){var f=splitPathRe.exec(path)[2]||"";if(ext&&f.substr(-1*ext.length)===ext){f=f.substr(0,f.length-ext.length)}return f};exports.extname=function(path){return splitPathRe.exec(path)[3]||""};exports.relative=function(from,to){from=exports.resolve(from).substr(1);to=exports.resolve(to).substr(1);function trim(arr){var start=0;for(;start<arr.length;start++){if(arr[start]!=="")break}var end=arr.length-1;for(;end>=0;end--){if(arr[end]!=="")break}if(start>end)return[];return arr.slice(start,end-start+1)}var fromParts=trim(from.split("/"));var toParts=trim(to.split("/"));var length=Math.min(fromParts.length,toParts.length);var samePartsLength=length;for(var i=0;i<length;i++){if(fromParts[i]!==toParts[i]){samePartsLength=i;break}}var outputParts=[];for(var i=samePartsLength;i<fromParts.length;i++){outputParts.push("..")}outputParts=outputParts.concat(toParts.slice(samePartsLength));return outputParts.join("/")}});require.define("__browserify_process",function(require,module,exports,__dirname,__filename,process,global){var process=module.exports={};process.nextTick=function(){var canSetImmediate=typeof window!=="undefined"&&window.setImmediate;var canPost=typeof window!=="undefined"&&window.postMessage&&window.addEventListener;if(canSetImmediate){return function(f){return window.setImmediate(f)}}if(canPost){var queue=[];window.addEventListener("message",function(ev){if(ev.source===window&&ev.data==="browserify-tick"){ev.stopPropagation();if(queue.length>0){var fn=queue.shift();fn()}}},true);return function nextTick(fn){queue.push(fn);window.postMessage("browserify-tick","*")}}return function nextTick(fn){setTimeout(fn,0)}}();process.title="browser";process.browser=true;process.env={};process.argv=[];process.binding=function(name){if(name==="evals")return require("vm");else throw new Error("No such module. (Possibly not yet loaded)")};(function(){var cwd="/";var path;process.cwd=function(){return cwd};process.chdir=function(dir){if(!path)path=require("path");cwd=path.resolve(dir,cwd)}})()});require.define("/lib/container.js",function(require,module,exports,__dirname,__filename,process,global){module.exports=require("./container/proto")});require.define("/lib/container/proto.js",function(require,module,exports,__dirname,__filename,process,global){var _=require("lodash");var EventEmitter=require("events").EventEmitter;var deepdot=require("./deepdot");var async=require("async");var inspectselect=require("./inspectselect");var find=require("./find");var search=require("./search");var XML=require("./xml");var utils=require("../utils");var Contract=require("../contract");var PortalWrapper=require("../portal/wrapper");var Router=require("./router");var eyes=require("eyes");var Container=module.exports=function(){};var finder=find(search.searcher);Container._=_;Container.factory=factory;Container.new=factory;Container.bigid=utils.quarryid;Container.littleid=utils.littleid;Container.request=Contract.request;Container.response=Contract.response;Container.fromskeleton=function(skeleton){var containerdata=[];if(skeleton){if(!_.isArray(skeleton)){skeleton=[skeleton]}containerdata=_.map(skeleton,function(data){return{meta:data}})}return factory(containerdata)};Container.connect=function(supplychain,stackpath){var route=Router.url(stackpath);var container=Container.new("supplychain",{name:"Supply Chain: "+route.department+":"+route.url}).meta({tagname:"supplychain",supplychainroot:true,quarrydepartment:route.department,quarrysupplier:route.url});container.supplychain=supplychain;container.connect=function(path){return Container.connect(supplychain,path)};return container};function extractdata(data,attr){var ensureids=false;if(_.isString(data)){if(data.match(/^\s*\</)){data=XML.parse(data);ensureids=true}else if(data.match(/^\s*[\[\{]/)){data=JSON.parse(data)}else{data=[{meta:{tagname:data},attr:attr||{}}];ensureids=true}}else if(!_.isArray(data)){if(!data){data={}}data=[data]}return{arr:data,ensureids:ensureids}}function factory(data,attr){data=extractdata(data,attr);var arr=data.arr;var ensureids=data.ensureids;function quarrycontainer(){return quarrycontainer.selector.apply(quarrycontainer,arguments)}_.extend(quarrycontainer,Container.prototype);_.extend(quarrycontainer,EventEmitter.prototype);_.extend(quarrycontainer,{create:factory,littleid:utils.littleid});quarrycontainer.initialize(arr);if(ensureids){quarrycontainer.ensure_ids()}return quarrycontainer}Container.prototype.bootstrapbrowser=require("./browser")(Container);Container.browserhtml=function(compileconfig,corecode){var code="this.$quarryconfig = "+JSON.stringify(compileconfig)+";\n\n";code+=corecode;code+=["(function(window){","   var Proto = require('/lib/container/proto');","   window.$quarry = Proto.prototype.bootstrapbrowser(window.$quarryconfig);","   window._ = Proto._;","})(this)"].join("\n");return code};Container.prototype.initialize=function(data){var self=this;this._promise=null;this.models=_.map(data||[],function(model){model.meta||(model.meta={classnames:[]});model.data||(model.data={});model.children||(model.children=[]);model.meta.quarryid||(model.meta.quarryid=utils.quarryid());return model});this.supplychain=null;this.Proto=Container;return this};Container.prototype.clone=function(new_ids){var ret=this.spawn(JSON.parse(JSON.stringify(this.toJSON())));if(new_ids){ret.recurse(function(container){container.replaceproperty("meta",{quarryid:utils.quarryid(),tagname:container.tagname(),classnames:container.classnames(),id:container.id()});delete container.models[0]._id;delete container.models[0].data})}return ret};Container.prototype.spawn=function(models){var self=this;if(arguments.length<=0||models==null){models=[]}else if(!_.isArray(models)){models=[models]}_.each(models,function(model){if(!model.meta){throw new Error("there is no meta level to the container data - probably a skeleton passed as container data")}if(!model.meta.quarrysupplier){model.meta.quarrysupplier=self.quarrysupplier()}});var ret=factory(models);ret.supplychain=this.supplychain;return ret};Container.prototype.blank=function(){return this.spawn([])};Container.prototype.blueprint=function(potential_parent){var ret=this.spawn(JSON.parse(JSON.stringify(this.toJSON())));ret.quarryid(utils.quarryid());ret.meta("quarrysupplier",potential_parent.quarrysupplier());ret.meta("quarrydepartment",potential_parent.quarrydepartment());ret.attr("name","");return ret};Container.prototype.fieldlist=function(without_name){var fields=this.meta("fieldlist")||[];var foundfields={};_.each(fields,function(field){foundfields[field.property]=true});if(!foundfields["attr.name"]&&!without_name){fields.unshift({title:"Name",property:"attr.name",type:"text"});foundfields["attr.name"]=true}return fields};Container.prototype.skeleton=function(){return this.models.length>0?this.models[0].meta:{}};Container.prototype.ensure_ids=function(){this.recurse(function(container){_.each(container.models,function(model){model.meta||(model.meta={});!model.meta.quarryid?model.meta.quarryid=utils.quarryid():null})});return this};Container.prototype.toJSON=function(){return JSON.parse(JSON.stringify(this.models))};Container.prototype.summary=function(options){options||(options={});var parts=[];var title=this.attr("name")||this.attr("title")||"";if(title.length>0&&options.title!=false){parts.push(title+": ")}parts.push(this.tagname());var id=this.id()||"";if(id.length>0){parts.push("#"+id)}var classnames=this.classnames()||[];if(classnames.length>0){parts=parts.concat(_.map(classnames,function(classname){return"."+classname}))}return parts.join("")};Container.prototype.look=function(){console.log(this.peek())};Container.prototype.peek=function(depth){if(this.count()<=0){return"no data to look at"}depth||(depth=0);var st="";function single(c){var indent="";for(var i=0;i<=depth;i++){indent+="--"}st+=indent+c.summary()+"\n";c.children().each(function(child){st+=child.peek(depth+1)})}this.each(single);return st};function valuereader(model,name){return deepdot(model,name)}function valuesetter(models,name,value,silent){_.each(models,function(model){deepdot(model,name,value)})}function wrapper(key,options){options||(options={});if(_.isString(options)){options={leaf:options}}var leaf=options.leaf;var fullkey=leaf?key+"."+leaf:key;fullkey=fullkey.replace(/^\./,"");return function(){var self=this;if(arguments.length<=0){return valuereader(this.models[0],fullkey)}else if(arguments.length==1&&_.isString(arguments[0])&&!leaf){return valuereader(this.models[0],[key,arguments[0]].join("."))}else if(arguments.length==1){var name=fullkey;valuesetter(this.models,fullkey,arguments[0],this._silent);return self}else if(arguments.length>1){valuesetter(this.models,[fullkey,arguments[0]].join("."),arguments[1],this._silent);return self}}}function remove_wrapper(topprop){return function(prop){var self=this;if(arguments.length<=0){return this}if(!_.isArray(prop)){prop=[prop]}_.each(prop,function(p){self[topprop](p,null)});return this}}var attrwrapper=wrapper("attr");Container.prototype.replaceproperty=function(prop,val){_.each(this.models,function(model){model[prop]=val});return this};Container.prototype.full=function(){return!this.empty()};Container.prototype.empty=function(){return this.count()==0};Container.prototype.attr=wrapper("attr");Container.prototype.removeAttr=remove_wrapper("attr");Container.prototype.get_value=function(field){var model=this.get(0);if(!model){return null}return deepdot(model,field)};Container.prototype.set_value=function(field,value){var model=this.get(0);if(!model){return null}deepdot(model,field,value);return this};Container.prototype.meta=wrapper("meta");Container.prototype.removeMeta=remove_wrapper("meta");Container.prototype.data=wrapper("data");Container.prototype.removeData=remove_wrapper("data");Container.prototype.quarryid=wrapper("meta","quarryid");Container.prototype.quarryportal=wrapper("meta","quarryportal");Container.prototype.quarrysupplier=wrapper("meta","quarrysupplier");Container.prototype.quarrydepartment=wrapper("meta","quarrydepartment");Container.prototype.id=wrapper("meta","id");Container.prototype.tagname=wrapper("meta","tagname");Container.prototype.classnames=wrapper("meta","classnames");Container.prototype.reset=function(field){this.attr(field,"");return this};Container.prototype.icon=function(val){if(val){this.meta("icon",val);return this}var ret=this.meta("icon")||"default/container.png";if(!ret.match(/^\//)){ret="/icons/"+ret}return ret};Container.prototype.title=function(){if(this.attr("name")){return this.attr("name")}else if(this.attr("title")){return this.attr("title")}else{return this.tagname()}};Container.prototype.events=wrapper("meta","events");Container.prototype.addClass=function(classname){var self=this;_.each(this.models,function(model){var classnames=_.unique((deepdot(model,"meta.classnames")||[]).concat(classname));deepdot(model,"meta.classnames",classnames)});return this};Container.prototype.removeClass=function(classname){var self=this;_.each(this.models,function(model){var classnames=_.without(deepdot(model,"meta.classnames")||[],classname);deepdot(model,"meta.classnames",classnames)});return this};Container.prototype.hasClass=function(classname){return _.contains(this.classnames()||[],classname)};Container.prototype.hasAttr=function(name){return!_.isEmpty(this.attr(name))};Container.prototype.clean=function(){return this};Container.prototype.get=function(index){return this.models[index]};Container.prototype.eq=function(index){return this.spawn(this.get(index))};Container.prototype.first=function(index){return this.spawn(this.get(0))};Container.prototype.last=function(index){return this.spawn(this.get(this.count()-1))};Container.prototype.range=function(from,to){return this.spawn(this.models.slice(from,to))};Container.prototype.byid=function(id){return _.find(this.models,function(model){return deepdot(model,"meta.quarryid")==id})};Container.prototype.inject=function(replacement){var selfmap=this.containermap(true);var replacemap=replacement.containermap(true);_.each(replacemap,function(replacecontainer,id){var selfcontainer=selfmap[id];var selfmodel=selfcontainer.get(0);var replacemodel=replacecontainer.get(0);var injectdata=_.clone(replacemodel);delete replacemodel.children;utils.extend(selfmodel,replacemodel)});return this};Container.prototype.add=function(container,clear_first){var self=this;if(clear_first){this.models=[]}this.models=this.models.concat(container.models);return this};Container.prototype.pourInto=function(target,clear_first){target.add(this,clear_first);return this};Container.prototype.count=function(){return this.models.length};Container.prototype.each=function(fn,asyncfn){if(asyncfn){async.forEachSeries(this.containers(),function(container,next){fn(container);next()},function(){asyncfn()})}else{_.each(this.containers(),fn)}return this};Container.prototype.map=function(fn){return _.map(this.containers(),fn)};Container.prototype.containers=function(){var self=this;return _.map(this.models,function(model){var ret=self.spawn(model);ret.parent=self.parent;return ret})};Container.prototype.containermap=function(deep){var map={};if(deep){this.recurse(function(container){map[container.quarryid()]=container})}else{this.each(function(container){map[container.quarryid()]=container})}return map};Container.prototype.children=function(){var self=this;var all_models=[];_.each(this.models,function(model){var router=Router(model.meta);var children=_.map(model.children||[],function(childmodel){childmodel.quarrysupplier=model.meta.quarrysupplier;return childmodel});all_models=all_models.concat(children)});var ret=this.spawn(all_models);ret.parent=this;return ret};Container.prototype.removechildren=function(removed){var self=this;var map=removed.containermap();_.each(this.models,function(model){model.children=_.filter(model.children,function(child_model){return map[child_model.meta.quarryid]==null})});return this};Container.prototype.addchildren=function(children){this.get(0).children=this.get(0).children.concat(children.models);return this};Container.prototype.remove=function(removed){var self=this;var map=removed.containermap();this.models=_.filter(this.models,function(model){return map[model.meta.quarryid]==null});return this};Container.prototype.recurse=function(fn,asyncfn){this.descendents().each(fn,asyncfn);return this};Container.prototype.descendents=function(){var all_models=[];function find_model(model){all_models.push(model);_.each(model.children,find_model)}_.each(this.models,find_model);return this.spawn(all_models)};Container.prototype.mapdescendents=function(fn){return this.spawn(this.map(function(container){var newmodel=fn(container.clone()).get(0);newmodel.children=container.children().map(function(child){var newchild=child.mapdescendents(fn);return newchild});return newmodel}))};Container.prototype.find=function(){var selector_strings=_.toArray(arguments);var selectors=_.map(selector_strings,inspectselect);return finder(selectors,this)};var sortfns={title:function(a,b){if(a.title().toLowerCase()<b.title().toLowerCase())return-1;if(a.title().toLowerCase()>b.title().toLowerCase())return 1;return 0}};Container.prototype.sort=function(fn){if(!fn){fn=sortfns.title}this.each(function(container){var newchildren=container.children().containers().sort(fn);var model=container.get(0);model.children=_.map(newchildren,function(container){return container.get(0)})});return this};Container.prototype.filter=function(filterfn){if(!_.isFunction(filterfn)){filterfn=search.compiler(filterfn)}var matching_container_array=_.filter(this.containers(),filterfn);var matching_models=[];_.each(matching_container_array,function(matching_container){matching_models=matching_models.concat(matching_container.models)});return this.spawn(matching_models)};Container.prototype.map=function(mapfn){return this.spawn(_.map(this.containers(),function(container){var mapped=mapfn(container);return mapped.models?mapped.models[0]:mapped}))};Container.prototype.match=function(selector){if(this.count()<=0){return false}var results=this.filter(selector);return results.count()>0};_.each(["series","parallel","waterfall"],function(method_name){Container.prototype[method_name]=async[method_name]});Container.prototype.portal=function(fn){var portal=PortalWrapper.portal(this);fn&&portal.sync(true,fn);return portal};Container.prototype.radio=function(){return PortalWrapper.radio(this)};Container.prototype.get_switchboard=function(){if(!this.supplychain){return null}return this.supplychain.switchboard||(this.supplychain.switchboardfactory?this.supplychain.switchboardfactory():null)};Container.prototype.router=function(){return Router(this.skeleton())};Container.prototype.contractfactory=function(){var contract=Contract.factory();contract.supplychain=this.supplychain;contract.container=this;return contract};Container.prototype.api=function(query){query.headers||(query.headers={});var self=this;var contract=this.contractfactory();contract.setType("merge");this.each(function(container){var raw=_.clone(query);raw.url=container.router().rpc();if(query.url&&query.url!="/"){raw.url+=query.url}raw.url=raw.url.replace(/\/\//g,"/");var req=Contract.request(raw);if(!req.getHeader("content-type")){req.setHeader("content-type","quarry/request")}contract.add(req)});return contract};Container.prototype.load=function(stackpath,callback){var self=this;var contract=this.contractfactory();contract.setType("merge");var req=Container.request({method:"get"});req.parseurl(stackpath);req.setHeader("content-type","quarry/request");contract.add(req);contract.map_response=function(res){return self.spawn(res.body)};return contract};Container.prototype.selector=function(){var args=_.toArray(arguments);if(!_.isString(args[0])&&_.isObject(args[0])){return this.api(args[0])}else if(_.isString(args[0])&&args[0].match(/^\//)){return this.api({method:"get",url:args[0]})}var selector_summary=args.reverse().join(" -> ");var json_selectors=_.map(args,function(selectorstring){return inspectselect(selectorstring)});var self=this;var contract=this.contractfactory();contract.setType("merge");contract.expect("containers");this.each(function(container){var req=Contract.request({method:"get",url:container.router().rpc()});req.setHeader("content-type","quarry/request");req.setHeader("x-quarry-department",container.quarrydepartment()||"warehouse");req.setHeader("x-json-skeleton",[container.meta()]);req.setHeader("x-selector-summary",selector_summary);req.setHeader("x-json-selectors",json_selectors);contract.add(req)});return contract};function childmodelmap(childmodel){var ret=JSON.parse(JSON.stringify(childmodel));ret.meta.quarryid=utils.quarryid();return ret}Container.prototype.append=function(childcontainers){var self=this;var appendto=this.eq(0);var ids=appendto.containermap(true);childcontainers=childcontainers.filter(function(container){return!ids[container.quarryid()]});var addedcontainers={};var contract=this.contractfactory();contract.setType("merge");contract.expect("containers");var req=Contract.request({method:"post",url:appendto.router().rpc()});if(childcontainers.empty()){return contract}var appenddata=[];req.setHeader("content-type","quarry/containers");req.setHeader("x-quarry-department",appendto.quarrydepartment()||"warehouse");function addchildcontainer(child){child.supplychain=appendto.supplychain;child.recurse(function(descendent){delete descendent.get(0).data;delete descendent.get(0).meta.quarrysupplier;addedcontainers[descendent.quarryid()]=descendent});appendto.models[0].children||(appendto.models[0].children=[]);appendto.models[0].children=appendto.models[0].children.concat(child.models);appenddata=appenddata.concat(child.toJSON())}if(!_.isArray(childcontainers)){childcontainers=[childcontainers]}_.each(childcontainers,function(childcontainer){addchildcontainer(childcontainer)});req.body=appenddata;contract.add(req);contract.on("ship",function(mainres){if(mainres.hasError()){return}var resultscontainers=self.spawn(mainres.body);resultscontainers.recurse(function(resultscontainer){var realcontainer=addedcontainers[resultscontainer.quarryid()];if(realcontainer){realcontainer.inject(resultscontainer)}})});return contract};Container.prototype.save=function(){var self=this;var contract=this.contractfactory();contract.setType("merge");this.each(function(savecontainer){var req=Contract.request({method:"put",url:savecontainer.router().rpc(),body:savecontainer.models[0]});req.setHeader("x-quarry-department",savecontainer.quarrydepartment()||"warehouse");req.setHeader("content-type","quarry/request");contract.add(req)});return contract};Container.prototype.delete=function(){var self=this;var contract=this.contractfactory();contract.setType("merge");this.each(function(deletecontainer){var req=Contract.request({method:"delete",url:deletecontainer.router().rpc()});req.setHeader("x-quarry-department",deletecontainer.quarrydepartment()||"warehouse");req.setHeader("content-type","quarry/request");contract.add(req)});contract.on("complete",function(mainres){self.models=[]});this.emit("delete");this.models=[];return contract};Container.prototype.addEvent=function(name,config){var events=this.events()||{};if(!events[name]){events[name]=[]}events[name].push(config);this.events(events);return this};Container.prototype.ghost=function(){var ghost=Container.new(this.tagname(),this.attr());ghost.id(this.id());ghost.meta("classnames",this.meta("classnames"));ghost.addEvent("select",{type:"branch",data:{id:this.quarryid(),supplier:this.quarrysupplier(),department:this.quarrydepartment(),url:this.router().rpc()}});return ghost};Container.prototype.merge=function(contracts){var contract=this.contractfactory();contract.setType("merge");_.each(contracts,function(req){contract.add(req)});return contract};Container.prototype.sequence=function(contracts){var contract=this.contractfactory();var results=[];return{ship:function(done){async.forEachSeries(contracts,function(contract,next){contract.ship(function(res){results.push(res);next()})},function(error){done&&done(results)})}}}});require.define("/node_modules/lodash/package.json",function(require,module,exports,__dirname,__filename,process,global){module.exports={main:"./dist/lodash"}});require.define("/node_modules/lodash/dist/lodash.js",function(require,module,exports,__dirname,__filename,process,global){(function(window,undefined){var freeExports=typeof exports=="object"&&exports;var freeGlobal=typeof global=="object"&&global;if(freeGlobal.global===freeGlobal){window=freeGlobal}var arrayRef=[],objectRef={};var idCounter=0;var indicatorObject=objectRef;var largeArraySize=30;var oldDash=window._;var reEscapedHtml=/&(?:amp|lt|gt|quot|#39);/g;var reEmptyStringLeading=/\b__p \+= '';/g,reEmptyStringMiddle=/\b(__p \+=) '' \+/g,reEmptyStringTrailing=/(__e\(.*?\)|\b__t\)) \+\n'';/g;var reFlags=/\w*$/;var reNative=RegExp("^"+(objectRef.valueOf+"").replace(/[.*+?^${}()|[\]\\]/g,"\\$&").replace(/valueOf|for [^\]]+/g,".+?")+"$");var reEsTemplate=/\$\{((?:(?=\\?)\\?[\s\S])*?)\}/g;var reInterpolate=/<%=([\s\S]+?)%>/g;var reNoMatch=/($^)/;var reUnescapedHtml=/[&<>"']/g;var reUnescapedString=/['\n\r\t\u2028\u2029\\]/g;var templateCounter=0;var ceil=Math.ceil,concat=arrayRef.concat,floor=Math.floor,getPrototypeOf=reNative.test(getPrototypeOf=Object.getPrototypeOf)&&getPrototypeOf,hasOwnProperty=objectRef.hasOwnProperty,push=arrayRef.push,toString=objectRef.toString;var nativeBind=reNative.test(nativeBind=slice.bind)&&nativeBind,nativeIsArray=reNative.test(nativeIsArray=Array.isArray)&&nativeIsArray,nativeIsFinite=window.isFinite,nativeIsNaN=window.isNaN,nativeKeys=reNative.test(nativeKeys=Object.keys)&&nativeKeys,nativeMax=Math.max,nativeMin=Math.min,nativeRandom=Math.random;var argsClass="[object Arguments]",arrayClass="[object Array]",boolClass="[object Boolean]",dateClass="[object Date]",funcClass="[object Function]",numberClass="[object Number]",objectClass="[object Object]",regexpClass="[object RegExp]",stringClass="[object String]";var isIeOpera=!!window.attachEvent,isV8=nativeBind&&!/\n|true/.test(nativeBind+isIeOpera);var isBindFast=nativeBind&&!isV8;var isKeysFast=nativeKeys&&(isIeOpera||isV8);var cloneableClasses={};cloneableClasses[funcClass]=false;cloneableClasses[argsClass]=cloneableClasses[arrayClass]=cloneableClasses[boolClass]=cloneableClasses[dateClass]=cloneableClasses[numberClass]=cloneableClasses[objectClass]=cloneableClasses[regexpClass]=cloneableClasses[stringClass]=true;var ctorByClass={};ctorByClass[arrayClass]=Array;ctorByClass[boolClass]=Boolean;ctorByClass[dateClass]=Date;ctorByClass[objectClass]=Object;ctorByClass[numberClass]=Number;ctorByClass[regexpClass]=RegExp;ctorByClass[stringClass]=String;var objectTypes={"boolean":false,"function":true,object:true,number:false,string:false,undefined:false};var stringEscapes={"\\":"\\","'":"'","\n":"n","\r":"r","	":"t","\u2028":"u2028","\u2029":"u2029"};function lodash(value){if(value&&typeof value=="object"&&value.__wrapped__){return value}if(!(this instanceof lodash)){return new lodash(value)}this.__wrapped__=value}lodash.templateSettings={escape:/<%-([\s\S]+?)%>/g,evaluate:/<%([\s\S]+?)%>/g,interpolate:reInterpolate,variable:"",imports:{_:lodash}};var iteratorTemplate=function(obj){var __p="var index, iterable = "+obj.firstArg+", result = iterable;\nif (!iterable) return result;\n"+obj.top+";\n";if(obj.arrays){__p+="var length = iterable.length; index = -1;\nif ("+obj.arrays+") {\n  while (++index < length) {\n    "+obj.loop+"\n  }\n}\nelse {  "}if(obj.isKeysFast&&obj.useHas){__p+="\n  var ownIndex = -1,\n      ownProps = objectTypes[typeof iterable] ? nativeKeys(iterable) : [],\n      length = ownProps.length;\n\n  while (++ownIndex < length) {\n    index = ownProps[ownIndex];\n    "+obj.loop+"\n  }  "}else{__p+="\n  for (index in iterable) {";if(obj.useHas){__p+="\n    if (";if(obj.useHas){__p+="hasOwnProperty.call(iterable, index)"}__p+=") {    "}__p+=obj.loop+";    ";if(obj.useHas){__p+="\n    }"}__p+="\n  }  "}if(obj.arrays){__p+="\n}"}__p+=obj.bottom+";\nreturn result";return __p};var defaultsIteratorOptions={args:"object, source, guard",top:"var args = arguments,\n"+"    argsIndex = 0,\n"+"    argsLength = typeof guard == 'number' ? 2 : args.length;\n"+"while (++argsIndex < argsLength) {\n"+"  iterable = args[argsIndex];\n"+"  if (iterable && objectTypes[typeof iterable]) {",loop:"if (typeof result[index] == 'undefined') result[index] = iterable[index]",bottom:"  }\n}"};var eachIteratorOptions={args:"collection, callback, thisArg",top:"callback = callback && typeof thisArg == 'undefined' ? callback : createCallback(callback, thisArg)",arrays:"typeof length == 'number'",loop:"if (callback(iterable[index], index, collection) === false) return result"};
var forOwnIteratorOptions={top:"if (!objectTypes[typeof iterable]) return result;\n"+eachIteratorOptions.top,arrays:false};function cachedContains(array,fromIndex,largeSize){fromIndex||(fromIndex=0);var length=array.length,isLarge=length-fromIndex>=(largeSize||largeArraySize);if(isLarge){var cache={},index=fromIndex-1;while(++index<length){var key=array[index]+"";(hasOwnProperty.call(cache,key)?cache[key]:cache[key]=[]).push(array[index])}}return function(value){if(isLarge){var key=value+"";return hasOwnProperty.call(cache,key)&&indexOf(cache[key],value)>-1}return indexOf(array,value,fromIndex)>-1}}function charAtCallback(value){return value.charCodeAt(0)}function compareAscending(a,b){var ai=a.index,bi=b.index;a=a.criteria;b=b.criteria;if(a!==b){if(a>b||typeof a=="undefined"){return 1}if(a<b||typeof b=="undefined"){return-1}}return ai<bi?-1:1}function createBound(func,thisArg,partialArgs,rightIndicator){var isFunc=isFunction(func),isPartial=!partialArgs,key=thisArg;if(isPartial){partialArgs=thisArg}if(!isFunc){thisArg=func}function bound(){var args=arguments,thisBinding=isPartial?this:thisArg;if(!isFunc){func=thisArg[key]}if(partialArgs.length){args=args.length?(args=slice(args),rightIndicator?args.concat(partialArgs):partialArgs.concat(args)):partialArgs}if(this instanceof bound){noop.prototype=func.prototype;thisBinding=new noop;noop.prototype=null;var result=func.apply(thisBinding,args);return isObject(result)?result:thisBinding}return func.apply(thisBinding,args)}return bound}function createCallback(func,thisArg,argCount){if(func==null){return identity}var type=typeof func;if(type!="function"){if(type!="object"){return function(object){return object[func]}}var props=keys(func);return function(object){var length=props.length,result=false;while(length--){if(!(result=isEqual(object[props[length]],func[props[length]],indicatorObject))){break}}return result}}if(typeof thisArg!="undefined"){if(argCount===1){return function(value){return func.call(thisArg,value)}}if(argCount===2){return function(a,b){return func.call(thisArg,a,b)}}if(argCount===4){return function(accumulator,value,index,object){return func.call(thisArg,accumulator,value,index,object)}}return function(value,index,object){return func.call(thisArg,value,index,object)}}return func}function createIterator(){var data={isKeysFast:isKeysFast,arrays:"isArray(iterable)",bottom:"",loop:"",top:"",useHas:true};for(var object,index=0;object=arguments[index];index++){for(var key in object){data[key]=object[key]}}var args=data.args;data.firstArg=/^[^,]+/.exec(args)[0];var factory=Function("createCallback, hasOwnProperty, isArguments, isArray, isString, "+"objectTypes, nativeKeys","return function("+args+") {\n"+iteratorTemplate(data)+"\n}");return factory(createCallback,hasOwnProperty,isArguments,isArray,isString,objectTypes,nativeKeys)}var each=createIterator(eachIteratorOptions);function escapeStringChar(match){return"\\"+stringEscapes[match]}function escapeHtmlChar(match){return htmlEscapes[match]}function isNode(value){return typeof value.toString!="function"&&typeof(value+"")=="string"}function noop(){}function slice(array,start,end){start||(start=0);if(typeof end=="undefined"){end=array?array.length:0}var index=-1,length=end-start||0,result=Array(length<0?0:length);while(++index<length){result[index]=array[start+index]}return result}function unescapeHtmlChar(match){return htmlUnescapes[match]}function isArguments(value){return toString.call(value)==argsClass}var forIn=createIterator(eachIteratorOptions,forOwnIteratorOptions,{useHas:false});var forOwn=createIterator(eachIteratorOptions,forOwnIteratorOptions);var isArray=nativeIsArray||function(value){return value instanceof Array||toString.call(value)==arrayClass};var keys=!nativeKeys?shimKeys:function(object){if(!isObject(object)){return[]}return nativeKeys(object)};function shimIsPlainObject(value){var result=false;if(!(value&&typeof value=="object")||isArguments(value)){return result}var ctor=value.constructor;if(!isFunction(ctor)||ctor instanceof ctor){forIn(value,function(value,key){result=key});return result===false||hasOwnProperty.call(value,result)}return result}function shimKeys(object){var result=[];forOwn(object,function(value,key){result.push(key)});return result}var htmlEscapes={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"};var htmlUnescapes=invert(htmlEscapes);var assign=createIterator(defaultsIteratorOptions,{top:defaultsIteratorOptions.top.replace(";",";\n"+"if (argsLength > 2) {\n"+"  if (typeof args[argsLength - 2] == 'function') {\n"+"    var callback = createCallback(args[--argsLength - 1], args[argsLength--], 2);\n"+"  } else if (typeof args[argsLength - 1] == 'function') {\n"+"    callback = args[--argsLength];\n"+"  }\n"+"}"),loop:"result[index] = callback ? callback(result[index], iterable[index]) : iterable[index]"});function clone(value,deep,callback,thisArg,stackA,stackB){var result=value;if(typeof deep=="function"){thisArg=callback;callback=deep;deep=false}if(typeof callback=="function"){callback=typeof thisArg=="undefined"?callback:createCallback(callback,thisArg,1);result=callback(result);var done=typeof result!="undefined";if(!done){result=value}}var isObj=isObject(result);if(isObj){var className=toString.call(result);if(!cloneableClasses[className]){return result}var isArr=isArray(result)}if(!isObj||!deep){return isObj&&!done?isArr?slice(result):assign({},result):result}var ctor=ctorByClass[className];switch(className){case boolClass:case dateClass:return done?result:new ctor(+result);case numberClass:case stringClass:return done?result:new ctor(result);case regexpClass:return done?result:ctor(result.source,reFlags.exec(result))}stackA||(stackA=[]);stackB||(stackB=[]);var length=stackA.length;while(length--){if(stackA[length]==value){return stackB[length]}}if(!done){result=isArr?ctor(result.length):{};if(isArr){if(hasOwnProperty.call(value,"index")){result.index=value.index}if(hasOwnProperty.call(value,"input")){result.input=value.input}}}stackA.push(value);stackB.push(result);(isArr?forEach:forOwn)(done?result:value,function(objValue,key){result[key]=clone(objValue,deep,callback,undefined,stackA,stackB)});return result}function cloneDeep(value,callback,thisArg){return clone(value,true,callback,thisArg)}var defaults=createIterator(defaultsIteratorOptions);function functions(object){var result=[];forIn(object,function(value,key){if(isFunction(value)){result.push(key)}});return result.sort()}function has(object,property){return object?hasOwnProperty.call(object,property):false}function invert(object){var index=-1,props=keys(object),length=props.length,result={};while(++index<length){var key=props[index];result[object[key]]=key}return result}function isBoolean(value){return value===true||value===false||toString.call(value)==boolClass}function isDate(value){return value instanceof Date||toString.call(value)==dateClass}function isElement(value){return value?value.nodeType===1:false}function isEmpty(value){var result=true;if(!value){return result}var className=toString.call(value),length=value.length;if(className==arrayClass||className==stringClass||className==argsClass||className==objectClass&&typeof length=="number"&&isFunction(value.splice)){return!length}forOwn(value,function(){return result=false});return result}function isEqual(a,b,callback,thisArg,stackA,stackB){var whereIndicator=callback===indicatorObject;if(callback&&!whereIndicator){callback=typeof thisArg=="undefined"?callback:createCallback(callback,thisArg,2);var result=callback(a,b);if(typeof result!="undefined"){return!!result}}if(a===b){return a!==0||1/a==1/b}var type=typeof a,otherType=typeof b;if(a===a&&(!a||type!="function"&&type!="object")&&(!b||otherType!="function"&&otherType!="object")){return false}if(a==null||b==null){return a===b}var className=toString.call(a),otherClass=toString.call(b);if(className==argsClass){className=objectClass}if(otherClass==argsClass){otherClass=objectClass}if(className!=otherClass){return false}switch(className){case boolClass:case dateClass:return+a==+b;case numberClass:return a!=+a?b!=+b:a==0?1/a==1/b:a==+b;case regexpClass:case stringClass:return a==b+""}var isArr=className==arrayClass;if(!isArr){if(a.__wrapped__||b.__wrapped__){return isEqual(a.__wrapped__||a,b.__wrapped__||b,callback,thisArg,stackA,stackB)}if(className!=objectClass){return false}var ctorA=a.constructor,ctorB=b.constructor;if(ctorA!=ctorB&&!(isFunction(ctorA)&&ctorA instanceof ctorA&&isFunction(ctorB)&&ctorB instanceof ctorB)){return false}}stackA||(stackA=[]);stackB||(stackB=[]);var length=stackA.length;while(length--){if(stackA[length]==a){return stackB[length]==b}}var size=0;result=true;stackA.push(a);stackB.push(b);if(isArr){size=b.length;result=whereIndicator||size==a.length;if(result){while(size--){if(!(result=isEqual(a[size],b[size],callback,thisArg,stackA,stackB))){break}}}return result}forIn(b,function(value,key,b){if(hasOwnProperty.call(b,key)){size++;return result=hasOwnProperty.call(a,key)&&isEqual(a[key],value,callback,thisArg,stackA,stackB)}});if(result&&!whereIndicator){forIn(a,function(value,key,a){if(hasOwnProperty.call(a,key)){return result=--size>-1}})}return result}function isFinite(value){return nativeIsFinite(value)&&!nativeIsNaN(parseFloat(value))}function isFunction(value){return typeof value=="function"}if(isFunction(/x/)){isFunction=function(value){return value instanceof Function||toString.call(value)==funcClass}}function isObject(value){return value?objectTypes[typeof value]:false}function isNaN(value){return isNumber(value)&&value!=+value}function isNull(value){return value===null}function isNumber(value){return typeof value=="number"||toString.call(value)==numberClass}var isPlainObject=function(value){if(!(value&&typeof value=="object")){return false}var valueOf=value.valueOf,objProto=typeof valueOf=="function"&&(objProto=getPrototypeOf(valueOf))&&getPrototypeOf(objProto);return objProto?value==objProto||getPrototypeOf(value)==objProto&&!isArguments(value):shimIsPlainObject(value)};function isRegExp(value){return value instanceof RegExp||toString.call(value)==regexpClass}function isString(value){return typeof value=="string"||toString.call(value)==stringClass}function isUndefined(value){return typeof value=="undefined"}function merge(object,source,deepIndicator){var args=arguments,index=0,length=2;if(!isObject(object)){return object}if(deepIndicator===indicatorObject){var callback=args[3],stackA=args[4],stackB=args[5]}else{stackA=[];stackB=[];if(typeof deepIndicator!="number"){length=args.length}if(length>2){if(typeof args[length-2]=="function"){callback=createCallback(args[--length-1],args[length--],2)}else if(typeof args[length-1]=="function"){callback=args[--length]}}}while(++index<length){(isArray(args[index])?forEach:forOwn)(args[index],function(source,key){var found,isArr,result=source,value=object[key];if(source&&((isArr=isArray(source))||isPlainObject(source))){var stackLength=stackA.length;while(stackLength--){if(found=stackA[stackLength]==source){value=stackB[stackLength];break}}if(!found){value=isArr?isArray(value)?value:[]:isPlainObject(value)?value:{};if(callback){result=callback(value,source);if(typeof result!="undefined"){value=result}}stackA.push(source);stackB.push(value);if(!callback){value=merge(value,source,indicatorObject,callback,stackA,stackB)}}}else{if(callback){result=callback(value,source);if(typeof result=="undefined"){result=source}}if(typeof result!="undefined"){value=result}}object[key]=value})}return object}function omit(object,callback,thisArg){var isFunc=typeof callback=="function",result={};if(isFunc){callback=createCallback(callback,thisArg)}else{var props=concat.apply(arrayRef,arguments)}forIn(object,function(value,key,object){if(isFunc?!callback(value,key,object):indexOf(props,key,1)<0){result[key]=value}});return result}function pairs(object){var index=-1,props=keys(object),length=props.length,result=Array(length);while(++index<length){var key=props[index];result[index]=[key,object[key]]}return result}function pick(object,callback,thisArg){var result={};if(typeof callback!="function"){var index=0,props=concat.apply(arrayRef,arguments),length=isObject(object)?props.length:0;while(++index<length){var key=props[index];if(key in object){result[key]=object[key]}}}else{callback=createCallback(callback,thisArg);forIn(object,function(value,key,object){if(callback(value,key,object)){result[key]=value}})}return result}function values(object){var index=-1,props=keys(object),length=props.length,result=Array(length);while(++index<length){result[index]=object[props[index]]}return result}function at(collection){var index=-1,props=concat.apply(arrayRef,slice(arguments,1)),length=props.length,result=Array(length);while(++index<length){result[index]=collection[props[index]]}return result}function contains(collection,target,fromIndex){var index=-1,length=collection?collection.length:0,result=false;fromIndex=(fromIndex<0?nativeMax(0,length+fromIndex):fromIndex)||0;if(typeof length=="number"){result=(isString(collection)?collection.indexOf(target,fromIndex):indexOf(collection,target,fromIndex))>-1}else{each(collection,function(value){if(++index>=fromIndex){return!(result=value===target)}})}return result}function countBy(collection,callback,thisArg){var result={};callback=createCallback(callback,thisArg);forEach(collection,function(value,key,collection){key=callback(value,key,collection)+"";hasOwnProperty.call(result,key)?result[key]++:result[key]=1});return result}function every(collection,callback,thisArg){var result=true;callback=createCallback(callback,thisArg);if(isArray(collection)){var index=-1,length=collection.length;while(++index<length){if(!(result=!!callback(collection[index],index,collection))){break}}}else{each(collection,function(value,index,collection){return result=!!callback(value,index,collection)})}return result}function filter(collection,callback,thisArg){var result=[];callback=createCallback(callback,thisArg);if(isArray(collection)){var index=-1,length=collection.length;while(++index<length){var value=collection[index];if(callback(value,index,collection)){result.push(value)}}}else{each(collection,function(value,index,collection){if(callback(value,index,collection)){result.push(value)}})}return result}function find(collection,callback,thisArg){var result;callback=createCallback(callback,thisArg);forEach(collection,function(value,index,collection){if(callback(value,index,collection)){result=value;return false}});return result}function forEach(collection,callback,thisArg){if(callback&&typeof thisArg=="undefined"&&isArray(collection)){var index=-1,length=collection.length;while(++index<length){if(callback(collection[index],index,collection)===false){break}}}else{each(collection,callback,thisArg)}return collection}function groupBy(collection,callback,thisArg){var result={};callback=createCallback(callback,thisArg);forEach(collection,function(value,key,collection){key=callback(value,key,collection)+"";(hasOwnProperty.call(result,key)?result[key]:result[key]=[]).push(value)});return result}function invoke(collection,methodName){var args=slice(arguments,2),index=-1,isFunc=typeof methodName=="function",length=collection?collection.length:0,result=Array(typeof length=="number"?length:0);forEach(collection,function(value){result[++index]=(isFunc?methodName:value[methodName]).apply(value,args)});return result}function map(collection,callback,thisArg){var index=-1,length=collection?collection.length:0,result=Array(typeof length=="number"?length:0);callback=createCallback(callback,thisArg);if(isArray(collection)){while(++index<length){result[index]=callback(collection[index],index,collection)}}else{each(collection,function(value,key,collection){result[++index]=callback(value,key,collection)})}return result}function max(collection,callback,thisArg){var computed=-Infinity,result=computed;if(!callback&&isArray(collection)){var index=-1,length=collection.length;while(++index<length){var value=collection[index];if(value>result){result=value}}}else{callback=!callback&&isString(collection)?charAtCallback:createCallback(callback,thisArg);each(collection,function(value,index,collection){var current=callback(value,index,collection);if(current>computed){computed=current;result=value}})}return result}function min(collection,callback,thisArg){var computed=Infinity,result=computed;if(!callback&&isArray(collection)){var index=-1,length=collection.length;while(++index<length){var value=collection[index];if(value<result){result=value}}}else{callback=!callback&&isString(collection)?charAtCallback:createCallback(callback,thisArg);each(collection,function(value,index,collection){var current=callback(value,index,collection);if(current<computed){computed=current;result=value}})}return result}var pluck=map;function reduce(collection,callback,accumulator,thisArg){var noaccum=arguments.length<3;callback=createCallback(callback,thisArg,4);if(isArray(collection)){var index=-1,length=collection.length;if(noaccum){accumulator=collection[++index]}while(++index<length){accumulator=callback(accumulator,collection[index],index,collection)}}else{each(collection,function(value,index,collection){accumulator=noaccum?(noaccum=false,value):callback(accumulator,value,index,collection)})}return accumulator}function reduceRight(collection,callback,accumulator,thisArg){var iterable=collection,length=collection?collection.length:0,noaccum=arguments.length<3;if(typeof length!="number"){var props=keys(collection);length=props.length}callback=createCallback(callback,thisArg,4);forEach(collection,function(value,index,collection){index=props?props[--length]:--length;accumulator=noaccum?(noaccum=false,iterable[index]):callback(accumulator,iterable[index],index,collection)});return accumulator}function reject(collection,callback,thisArg){callback=createCallback(callback,thisArg);return filter(collection,function(value,index,collection){return!callback(value,index,collection)})}function shuffle(collection){var index=-1,length=collection?collection.length:0,result=Array(typeof length=="number"?length:0);forEach(collection,function(value){var rand=floor(nativeRandom()*(++index+1));result[index]=result[rand];result[rand]=value});return result}function size(collection){var length=collection?collection.length:0;return typeof length=="number"?length:keys(collection).length}function some(collection,callback,thisArg){var result;callback=createCallback(callback,thisArg);if(isArray(collection)){var index=-1,length=collection.length;while(++index<length){if(result=callback(collection[index],index,collection)){break}}}else{each(collection,function(value,index,collection){return!(result=callback(value,index,collection))})}return!!result}function sortBy(collection,callback,thisArg){var index=-1,length=collection?collection.length:0,result=Array(typeof length=="number"?length:0);callback=createCallback(callback,thisArg);forEach(collection,function(value,key,collection){result[++index]={criteria:callback(value,key,collection),index:index,value:value}});length=result.length;result.sort(compareAscending);while(length--){result[length]=result[length].value}return result}function toArray(collection){if(collection&&typeof collection.length=="number"){return slice(collection)}return values(collection)}var where=filter;function compact(array){var index=-1,length=array?array.length:0,result=[];while(++index<length){var value=array[index];if(value){result.push(value)}}return result}function difference(array){var index=-1,length=array?array.length:0,flattened=concat.apply(arrayRef,arguments),contains=cachedContains(flattened,length),result=[];while(++index<length){var value=array[index];if(!contains(value)){result.push(value)}}return result}function first(array,callback,thisArg){if(array){var n=0,length=array.length;if(typeof callback!="number"&&callback!=null){var index=-1;callback=createCallback(callback,thisArg);while(++index<length&&callback(array[index],index,array)){n++}}else{n=callback;if(n==null||thisArg){return array[0]}}return slice(array,0,nativeMin(nativeMax(0,n),length))}}function flatten(array,shallow){var index=-1,length=array?array.length:0,result=[];while(++index<length){var value=array[index];if(isArray(value)){push.apply(result,shallow?value:flatten(value))}else{result.push(value)}}return result}function indexOf(array,value,fromIndex){var index=-1,length=array?array.length:0;if(typeof fromIndex=="number"){index=(fromIndex<0?nativeMax(0,length+fromIndex):fromIndex||0)-1}else if(fromIndex){index=sortedIndex(array,value);return array[index]===value?index:-1}while(++index<length){if(array[index]===value){return index}}return-1}function initial(array,callback,thisArg){if(!array){return[]}var n=0,length=array.length;if(typeof callback!="number"&&callback!=null){var index=length;callback=createCallback(callback,thisArg);while(index--&&callback(array[index],index,array)){n++}}else{n=callback==null||thisArg?1:callback||n}return slice(array,0,nativeMin(nativeMax(0,length-n),length))}function intersection(array){var args=arguments,argsLength=args.length,cache={0:{}},index=-1,length=array?array.length:0,isLarge=length>=100,result=[],seen=result;outer:while(++index<length){var value=array[index];if(isLarge){var key=value+"";var inited=hasOwnProperty.call(cache[0],key)?!(seen=cache[0][key]):seen=cache[0][key]=[]}if(inited||indexOf(seen,value)<0){if(isLarge){seen.push(value)}var argsIndex=argsLength;while(--argsIndex){if(!(cache[argsIndex]||(cache[argsIndex]=cachedContains(args[argsIndex],0,100)))(value)){continue outer}}result.push(value)}}return result}function last(array,callback,thisArg){if(array){var n=0,length=array.length;if(typeof callback!="number"&&callback!=null){var index=length;callback=createCallback(callback,thisArg);while(index--&&callback(array[index],index,array)){n++}}else{n=callback;if(n==null||thisArg){return array[length-1]}}return slice(array,nativeMax(0,length-n))}}function lastIndexOf(array,value,fromIndex){var index=array?array.length:0;if(typeof fromIndex=="number"){index=(fromIndex<0?nativeMax(0,index+fromIndex):nativeMin(fromIndex,index-1))+1}while(index--){if(array[index]===value){return index}}return-1}function object(keys,values){var index=-1,length=keys?keys.length:0,result={};while(++index<length){var key=keys[index];if(values){result[key]=values[index]}else{result[key[0]]=key[1]}}return result}function range(start,end,step){start=+start||0;step=+step||1;if(end==null){end=start;start=0}var index=-1,length=nativeMax(0,ceil((end-start)/step)),result=Array(length);while(++index<length){result[index]=start;start+=step}return result}function rest(array,callback,thisArg){if(typeof callback!="number"&&callback!=null){var n=0,index=-1,length=array?array.length:0;callback=createCallback(callback,thisArg);while(++index<length&&callback(array[index],index,array)){n++}}else{n=callback==null||thisArg?1:nativeMax(0,callback)}return slice(array,n)}function sortedIndex(array,value,callback,thisArg){var low=0,high=array?array.length:low;callback=callback?createCallback(callback,thisArg,1):identity;value=callback(value);while(low<high){var mid=low+high>>>1;callback(array[mid])<value?low=mid+1:high=mid}return low}function union(){return uniq(concat.apply(arrayRef,arguments))}function uniq(array,isSorted,callback,thisArg){var index=-1,length=array?array.length:0,result=[],seen=result;if(typeof isSorted=="function"){thisArg=callback;callback=isSorted;isSorted=false}var isLarge=!isSorted&&length>=75;if(isLarge){var cache={}}if(callback){seen=[];callback=createCallback(callback,thisArg)}while(++index<length){var value=array[index],computed=callback?callback(value,index,array):value;if(isLarge){var key=computed+"";var inited=hasOwnProperty.call(cache,key)?!(seen=cache[key]):seen=cache[key]=[]}if(isSorted?!index||seen[seen.length-1]!==computed:inited||indexOf(seen,computed)<0){if(callback||isLarge){seen.push(computed)}result.push(value)}}return result}function without(array){var index=-1,length=array?array.length:0,contains=cachedContains(arguments,1),result=[];while(++index<length){var value=array[index];if(!contains(value)){result.push(value)}}return result}function zip(array){var index=-1,length=array?max(pluck(arguments,"length")):0,result=Array(length);while(++index<length){result[index]=pluck(arguments,index)}return result}function after(n,func){if(n<1){return func()}return function(){if(--n<1){return func.apply(this,arguments)}}}function bind(func,thisArg){return isBindFast||nativeBind&&arguments.length>2?nativeBind.call.apply(nativeBind,arguments):createBound(func,thisArg,slice(arguments,2))}function bindAll(object){var funcs=concat.apply(arrayRef,arguments),index=funcs.length>1?0:(funcs=functions(object),-1),length=funcs.length;while(++index<length){var key=funcs[index];object[key]=bind(object[key],object)}return object}function bindKey(object,key){return createBound(object,key,slice(arguments,2))}function compose(){var funcs=arguments;return function(){var args=arguments,length=funcs.length;while(length--){args=[funcs[length].apply(this,args)]}return args[0]}}function debounce(func,wait,immediate){var args,result,thisArg,timeoutId;function delayed(){timeoutId=null;if(!immediate){result=func.apply(thisArg,args)}}return function(){var isImmediate=immediate&&!timeoutId;args=arguments;thisArg=this;clearTimeout(timeoutId);timeoutId=setTimeout(delayed,wait);if(isImmediate){result=func.apply(thisArg,args)}return result}}function delay(func,wait){var args=slice(arguments,2);return setTimeout(function(){func.apply(undefined,args)},wait)}function defer(func){var args=slice(arguments,1);return setTimeout(function(){func.apply(undefined,args)},1)}function memoize(func,resolver){var cache={};return function(){var key=(resolver?resolver.apply(this,arguments):arguments[0])+"";return hasOwnProperty.call(cache,key)?cache[key]:cache[key]=func.apply(this,arguments)}}function once(func){var ran,result;return function(){if(ran){return result}ran=true;result=func.apply(this,arguments);func=null;return result}}function partial(func){return createBound(func,slice(arguments,1))}function partialRight(func){return createBound(func,slice(arguments,1),null,indicatorObject)}function throttle(func,wait){var args,result,thisArg,timeoutId,lastCalled=0;function trailingCall(){lastCalled=new Date;timeoutId=null;result=func.apply(thisArg,args)}return function(){var now=new Date,remaining=wait-(now-lastCalled);args=arguments;thisArg=this;if(remaining<=0){clearTimeout(timeoutId);timeoutId=null;lastCalled=now;result=func.apply(thisArg,args)}else if(!timeoutId){timeoutId=setTimeout(trailingCall,remaining)}return result}}function wrap(value,wrapper){return function(){var args=[value];push.apply(args,arguments);return wrapper.apply(this,args)}}function escape(string){return string==null?"":(string+"").replace(reUnescapedHtml,escapeHtmlChar)}function identity(value){return value}function mixin(object){forEach(functions(object),function(methodName){var func=lodash[methodName]=object[methodName];lodash.prototype[methodName]=function(){var args=[this.__wrapped__];push.apply(args,arguments);return new lodash(func.apply(lodash,args))}})}function noConflict(){window._=oldDash;return this}function random(min,max){if(min==null&&max==null){max=1}min=+min||0;if(max==null){max=min;min=0}return min+floor(nativeRandom()*((+max||0)-min+1))}function result(object,property){var value=object?object[property]:undefined;return isFunction(value)?object[property]():value}function template(text,data,options){var settings=lodash.templateSettings;text||(text="");options=defaults({},options,settings);var imports=defaults({},options.imports,settings.imports),importsKeys=keys(imports),importsValues=values(imports);var isEvaluating,index=0,interpolate=options.interpolate||reNoMatch,source="__p += '";var reDelimiters=RegExp((options.escape||reNoMatch).source+"|"+interpolate.source+"|"+(interpolate===reInterpolate?reEsTemplate:reNoMatch).source+"|"+(options.evaluate||reNoMatch).source+"|$","g");text.replace(reDelimiters,function(match,escapeValue,interpolateValue,esTemplateValue,evaluateValue,offset){interpolateValue||(interpolateValue=esTemplateValue);source+=text.slice(index,offset).replace(reUnescapedString,escapeStringChar);if(escapeValue){source+="' +\n__e("+escapeValue+") +\n'"}if(evaluateValue){isEvaluating=true;source+="';\n"+evaluateValue+";\n__p += '"}if(interpolateValue){source+="' +\n((__t = ("+interpolateValue+")) == null ? '' : __t) +\n'"}index=offset+match.length;return match});source+="';\n";var variable=options.variable,hasVariable=variable;if(!hasVariable){variable="obj";source="with ("+variable+") {\n"+source+"\n}\n"}source=(isEvaluating?source.replace(reEmptyStringLeading,""):source).replace(reEmptyStringMiddle,"$1").replace(reEmptyStringTrailing,"$1;");source="function("+variable+") {\n"+(hasVariable?"":variable+" || ("+variable+" = {});\n")+"var __t, __p = '', __e = _.escape"+(isEvaluating?", __j = Array.prototype.join;\n"+"function print() { __p += __j.call(arguments, '') }\n":(hasVariable?"":", __d = "+variable+"."+variable+" || "+variable)+";\n")+source+"return __p\n}";var sourceURL="\n/*\n//@ sourceURL="+(options.sourceURL||"/lodash/template/source["+templateCounter++ +"]")+"\n*/";try{var result=Function(importsKeys,"return "+source+sourceURL).apply(undefined,importsValues)}catch(e){e.source=source;throw e}if(data){return result(data)}result.source=source;return result}function times(n,callback,thisArg){n=+n||0;var index=-1,result=Array(n);while(++index<n){result[index]=callback.call(thisArg,index)}return result}function unescape(string){return string==null?"":(string+"").replace(reEscapedHtml,unescapeHtmlChar)}function uniqueId(prefix){var id=++idCounter;return(prefix==null?"":prefix+"")+id}function tap(value,interceptor){interceptor(value);return value}function wrapperToString(){return this.__wrapped__+""}function wrapperValueOf(){return this.__wrapped__}lodash.after=after;lodash.assign=assign;lodash.at=at;lodash.bind=bind;lodash.bindAll=bindAll;lodash.bindKey=bindKey;lodash.compact=compact;lodash.compose=compose;lodash.countBy=countBy;lodash.debounce=debounce;lodash.defaults=defaults;lodash.defer=defer;lodash.delay=delay;lodash.difference=difference;lodash.filter=filter;lodash.flatten=flatten;lodash.forEach=forEach;lodash.forIn=forIn;lodash.forOwn=forOwn;lodash.functions=functions;lodash.groupBy=groupBy;lodash.initial=initial;lodash.intersection=intersection;lodash.invert=invert;lodash.invoke=invoke;lodash.keys=keys;lodash.map=map;lodash.max=max;lodash.memoize=memoize;lodash.merge=merge;lodash.min=min;lodash.object=object;lodash.omit=omit;lodash.once=once;lodash.pairs=pairs;lodash.partial=partial;lodash.partialRight=partialRight;lodash.pick=pick;lodash.pluck=pluck;lodash.range=range;lodash.reject=reject;lodash.rest=rest;lodash.shuffle=shuffle;lodash.sortBy=sortBy;lodash.tap=tap;lodash.throttle=throttle;lodash.times=times;lodash.toArray=toArray;lodash.union=union;lodash.uniq=uniq;lodash.values=values;lodash.where=where;lodash.without=without;lodash.wrap=wrap;lodash.zip=zip;lodash.collect=map;lodash.drop=rest;lodash.each=forEach;lodash.extend=assign;lodash.methods=functions;lodash.select=filter;lodash.tail=rest;lodash.unique=uniq;mixin(lodash);lodash.clone=clone;lodash.cloneDeep=cloneDeep;lodash.contains=contains;lodash.escape=escape;lodash.every=every;lodash.find=find;lodash.has=has;lodash.identity=identity;lodash.indexOf=indexOf;lodash.isArguments=isArguments;lodash.isArray=isArray;lodash.isBoolean=isBoolean;lodash.isDate=isDate;lodash.isElement=isElement;lodash.isEmpty=isEmpty;lodash.isEqual=isEqual;lodash.isFinite=isFinite;lodash.isFunction=isFunction;lodash.isNaN=isNaN;lodash.isNull=isNull;lodash.isNumber=isNumber;lodash.isObject=isObject;lodash.isPlainObject=isPlainObject;lodash.isRegExp=isRegExp;lodash.isString=isString;lodash.isUndefined=isUndefined;lodash.lastIndexOf=lastIndexOf;lodash.mixin=mixin;lodash.noConflict=noConflict;lodash.random=random;lodash.reduce=reduce;lodash.reduceRight=reduceRight;lodash.result=result;
lodash.size=size;lodash.some=some;lodash.sortedIndex=sortedIndex;lodash.template=template;lodash.unescape=unescape;lodash.uniqueId=uniqueId;lodash.all=every;lodash.any=some;lodash.detect=find;lodash.foldl=reduce;lodash.foldr=reduceRight;lodash.include=contains;lodash.inject=reduce;forOwn(lodash,function(func,methodName){if(!lodash.prototype[methodName]){lodash.prototype[methodName]=function(){var args=[this.__wrapped__];push.apply(args,arguments);return func.apply(lodash,args)}}});lodash.first=first;lodash.last=last;lodash.take=first;lodash.head=first;forOwn(lodash,function(func,methodName){if(!lodash.prototype[methodName]){lodash.prototype[methodName]=function(callback,thisArg){var result=func(this.__wrapped__,callback,thisArg);return callback==null||thisArg&&typeof callback!="function"?result:new lodash(result)}}});lodash.VERSION="1.0.0";lodash.prototype.toString=wrapperToString;lodash.prototype.value=wrapperValueOf;lodash.prototype.valueOf=wrapperValueOf;each(["join","pop","shift"],function(methodName){var func=arrayRef[methodName];lodash.prototype[methodName]=function(){return func.apply(this.__wrapped__,arguments)}});each(["push","reverse","sort","unshift"],function(methodName){var func=arrayRef[methodName];lodash.prototype[methodName]=function(){func.apply(this.__wrapped__,arguments);return this}});each(["concat","slice","splice"],function(methodName){var func=arrayRef[methodName];lodash.prototype[methodName]=function(){return new lodash(func.apply(this.__wrapped__,arguments))}});if(typeof define=="function"&&typeof define.amd=="object"&&define.amd){window._=lodash;define(function(){return lodash})}else if(freeExports){if(typeof module=="object"&&module&&module.exports==freeExports){(module.exports=lodash)._=lodash}else{freeExports._=lodash}}else{window._=lodash}})(this)});require.define("events",function(require,module,exports,__dirname,__filename,process,global){if(!process.EventEmitter)process.EventEmitter=function(){};var EventEmitter=exports.EventEmitter=process.EventEmitter;var isArray=typeof Array.isArray==="function"?Array.isArray:function(xs){return Object.prototype.toString.call(xs)==="[object Array]"};function indexOf(xs,x){if(xs.indexOf)return xs.indexOf(x);for(var i=0;i<xs.length;i++){if(x===xs[i])return i}return-1}var defaultMaxListeners=10;EventEmitter.prototype.setMaxListeners=function(n){if(!this._events)this._events={};this._events.maxListeners=n};EventEmitter.prototype.emit=function(type){if(type==="error"){if(!this._events||!this._events.error||isArray(this._events.error)&&!this._events.error.length){if(arguments[1]instanceof Error){throw arguments[1]}else{throw new Error("Uncaught, unspecified 'error' event.")}return false}}if(!this._events)return false;var handler=this._events[type];if(!handler)return false;if(typeof handler=="function"){switch(arguments.length){case 1:handler.call(this);break;case 2:handler.call(this,arguments[1]);break;case 3:handler.call(this,arguments[1],arguments[2]);break;default:var args=Array.prototype.slice.call(arguments,1);handler.apply(this,args)}return true}else if(isArray(handler)){var args=Array.prototype.slice.call(arguments,1);var listeners=handler.slice();for(var i=0,l=listeners.length;i<l;i++){listeners[i].apply(this,args)}return true}else{return false}};EventEmitter.prototype.addListener=function(type,listener){if("function"!==typeof listener){throw new Error("addListener only takes instances of Function")}if(!this._events)this._events={};this.emit("newListener",type,listener);if(!this._events[type]){this._events[type]=listener}else if(isArray(this._events[type])){if(!this._events[type].warned){var m;if(this._events.maxListeners!==undefined){m=this._events.maxListeners}else{m=defaultMaxListeners}if(m&&m>0&&this._events[type].length>m){this._events[type].warned=true;console.error("(node) warning: possible EventEmitter memory "+"leak detected. %d listeners added. "+"Use emitter.setMaxListeners() to increase limit.",this._events[type].length);console.trace()}}this._events[type].push(listener)}else{this._events[type]=[this._events[type],listener]}return this};EventEmitter.prototype.on=EventEmitter.prototype.addListener;EventEmitter.prototype.once=function(type,listener){var self=this;self.on(type,function g(){self.removeListener(type,g);listener.apply(this,arguments)});return this};EventEmitter.prototype.removeListener=function(type,listener){if("function"!==typeof listener){throw new Error("removeListener only takes instances of Function")}if(!this._events||!this._events[type])return this;var list=this._events[type];if(isArray(list)){var i=indexOf(list,listener);if(i<0)return this;list.splice(i,1);if(list.length==0)delete this._events[type]}else if(this._events[type]===listener){delete this._events[type]}return this};EventEmitter.prototype.removeAllListeners=function(type){if(type&&this._events&&this._events[type])this._events[type]=null;return this};EventEmitter.prototype.listeners=function(type){if(!this._events)this._events={};if(!this._events[type])this._events[type]=[];if(!isArray(this._events[type])){this._events[type]=[this._events[type]]}return this._events[type]}});require.define("/lib/container/deepdot.js",function(require,module,exports,__dirname,__filename,process,global){var _=require("lodash");var extend=require("xtend");var EventEmitter=require("events").EventEmitter;module.exports=deepdot;module.exports.factory=factory;function update(obj,prop,value){var existing_prop=obj[prop];if(_.isObject(obj[prop])&&_.isObject(value)){extend(obj[prop],value)}else{obj[prop]=value}return value}function deepdot(obj,prop,value){if(obj==null){return null}if(!prop){return""}var parts=prop.split(".");var last=parts.pop();var current=obj;var setmode=arguments.length>=3;if(!_.isObject(current)){return current}while(parts.length>0&&current!=null){var nextpart=parts.shift();var nextvalue=current[nextpart];if(!nextvalue){if(setmode){nextvalue=current[nextpart]={}}else{break}}else{if(!_.isObject(nextvalue)){break}}current=nextvalue}if(!_.isObject(current)){return current}if(setmode){return update(current,last,value)}else{return current[last]}}function factory(obj){function dot(){var args=_.toArray(arguments);args.unshift(obj);var ret=deepdot.apply(null,args);if(arguments.length>1){dot.emit("change",arguments[0],arguments[1])}return ret}_.extend(dot,EventEmitter.prototype);return dot}});require.define("/node_modules/xtend/package.json",function(require,module,exports,__dirname,__filename,process,global){module.exports={main:"index"}});require.define("/node_modules/xtend/index.js",function(require,module,exports,__dirname,__filename,process,global){module.exports=extend;function extend(target){for(var i=1;i<arguments.length;i++){var source=arguments[i],keys=Object.keys(source);for(var j=0;j<keys.length;j++){var name=keys[j];target[name]=source[name]}}return target}});require.define("/node_modules/async/package.json",function(require,module,exports,__dirname,__filename,process,global){module.exports={main:"./index"}});require.define("/node_modules/async/index.js",function(require,module,exports,__dirname,__filename,process,global){module.exports=require("./lib/async")});require.define("/node_modules/async/lib/async.js",function(require,module,exports,__dirname,__filename,process,global){(function(){var async={};var root=this,previous_async=root.async;if(typeof module!=="undefined"&&module.exports){module.exports=async}else{root.async=async}async.noConflict=function(){root.async=previous_async;return async};var _forEach=function(arr,iterator){if(arr.forEach){return arr.forEach(iterator)}for(var i=0;i<arr.length;i+=1){iterator(arr[i],i,arr)}};var _map=function(arr,iterator){if(arr.map){return arr.map(iterator)}var results=[];_forEach(arr,function(x,i,a){results.push(iterator(x,i,a))});return results};var _reduce=function(arr,iterator,memo){if(arr.reduce){return arr.reduce(iterator,memo)}_forEach(arr,function(x,i,a){memo=iterator(memo,x,i,a)});return memo};var _keys=function(obj){if(Object.keys){return Object.keys(obj)}var keys=[];for(var k in obj){if(obj.hasOwnProperty(k)){keys.push(k)}}return keys};if(typeof process==="undefined"||!process.nextTick){async.nextTick=function(fn){setTimeout(fn,0)}}else{async.nextTick=process.nextTick}async.forEach=function(arr,iterator,callback){callback=callback||function(){};if(!arr.length){return callback()}var completed=0;_forEach(arr,function(x){iterator(x,function(err){if(err){callback(err);callback=function(){}}else{completed+=1;if(completed===arr.length){callback(null)}}})})};async.forEachSeries=function(arr,iterator,callback){callback=callback||function(){};if(!arr.length){return callback()}var completed=0;var iterate=function(){iterator(arr[completed],function(err){if(err){callback(err);callback=function(){}}else{completed+=1;if(completed===arr.length){callback(null)}else{iterate()}}})};iterate()};async.forEachLimit=function(arr,limit,iterator,callback){callback=callback||function(){};if(!arr.length||limit<=0){return callback()}var completed=0;var started=0;var running=0;(function replenish(){if(completed===arr.length){return callback()}while(running<limit&&started<arr.length){started+=1;running+=1;iterator(arr[started-1],function(err){if(err){callback(err);callback=function(){}}else{completed+=1;running-=1;if(completed===arr.length){callback()}else{replenish()}}})}})()};var doParallel=function(fn){return function(){var args=Array.prototype.slice.call(arguments);return fn.apply(null,[async.forEach].concat(args))}};var doSeries=function(fn){return function(){var args=Array.prototype.slice.call(arguments);return fn.apply(null,[async.forEachSeries].concat(args))}};var _asyncMap=function(eachfn,arr,iterator,callback){var results=[];arr=_map(arr,function(x,i){return{index:i,value:x}});eachfn(arr,function(x,callback){iterator(x.value,function(err,v){results[x.index]=v;callback(err)})},function(err){callback(err,results)})};async.map=doParallel(_asyncMap);async.mapSeries=doSeries(_asyncMap);async.reduce=function(arr,memo,iterator,callback){async.forEachSeries(arr,function(x,callback){iterator(memo,x,function(err,v){memo=v;callback(err)})},function(err){callback(err,memo)})};async.inject=async.reduce;async.foldl=async.reduce;async.reduceRight=function(arr,memo,iterator,callback){var reversed=_map(arr,function(x){return x}).reverse();async.reduce(reversed,memo,iterator,callback)};async.foldr=async.reduceRight;var _filter=function(eachfn,arr,iterator,callback){var results=[];arr=_map(arr,function(x,i){return{index:i,value:x}});eachfn(arr,function(x,callback){iterator(x.value,function(v){if(v){results.push(x)}callback()})},function(err){callback(_map(results.sort(function(a,b){return a.index-b.index}),function(x){return x.value}))})};async.filter=doParallel(_filter);async.filterSeries=doSeries(_filter);async.select=async.filter;async.selectSeries=async.filterSeries;var _reject=function(eachfn,arr,iterator,callback){var results=[];arr=_map(arr,function(x,i){return{index:i,value:x}});eachfn(arr,function(x,callback){iterator(x.value,function(v){if(!v){results.push(x)}callback()})},function(err){callback(_map(results.sort(function(a,b){return a.index-b.index}),function(x){return x.value}))})};async.reject=doParallel(_reject);async.rejectSeries=doSeries(_reject);var _detect=function(eachfn,arr,iterator,main_callback){eachfn(arr,function(x,callback){iterator(x,function(result){if(result){main_callback(x);main_callback=function(){}}else{callback()}})},function(err){main_callback()})};async.detect=doParallel(_detect);async.detectSeries=doSeries(_detect);async.some=function(arr,iterator,main_callback){async.forEach(arr,function(x,callback){iterator(x,function(v){if(v){main_callback(true);main_callback=function(){}}callback()})},function(err){main_callback(false)})};async.any=async.some;async.every=function(arr,iterator,main_callback){async.forEach(arr,function(x,callback){iterator(x,function(v){if(!v){main_callback(false);main_callback=function(){}}callback()})},function(err){main_callback(true)})};async.all=async.every;async.sortBy=function(arr,iterator,callback){async.map(arr,function(x,callback){iterator(x,function(err,criteria){if(err){callback(err)}else{callback(null,{value:x,criteria:criteria})}})},function(err,results){if(err){return callback(err)}else{var fn=function(left,right){var a=left.criteria,b=right.criteria;return a<b?-1:a>b?1:0};callback(null,_map(results.sort(fn),function(x){return x.value}))}})};async.auto=function(tasks,callback){callback=callback||function(){};var keys=_keys(tasks);if(!keys.length){return callback(null)}var results={};var listeners=[];var addListener=function(fn){listeners.unshift(fn)};var removeListener=function(fn){for(var i=0;i<listeners.length;i+=1){if(listeners[i]===fn){listeners.splice(i,1);return}}};var taskComplete=function(){_forEach(listeners.slice(0),function(fn){fn()})};addListener(function(){if(_keys(results).length===keys.length){callback(null,results);callback=function(){}}});_forEach(keys,function(k){var task=tasks[k]instanceof Function?[tasks[k]]:tasks[k];var taskCallback=function(err){if(err){callback(err);callback=function(){}}else{var args=Array.prototype.slice.call(arguments,1);if(args.length<=1){args=args[0]}results[k]=args;taskComplete()}};var requires=task.slice(0,Math.abs(task.length-1))||[];var ready=function(){return _reduce(requires,function(a,x){return a&&results.hasOwnProperty(x)},true)&&!results.hasOwnProperty(k)};if(ready()){task[task.length-1](taskCallback,results)}else{var listener=function(){if(ready()){removeListener(listener);task[task.length-1](taskCallback,results)}};addListener(listener)}})};async.waterfall=function(tasks,callback){callback=callback||function(){};if(!tasks.length){return callback()}var wrapIterator=function(iterator){return function(err){if(err){callback(err);callback=function(){}}else{var args=Array.prototype.slice.call(arguments,1);var next=iterator.next();if(next){args.push(wrapIterator(next))}else{args.push(callback)}async.nextTick(function(){iterator.apply(null,args)})}}};wrapIterator(async.iterator(tasks))()};async.parallel=function(tasks,callback){callback=callback||function(){};if(tasks.constructor===Array){async.map(tasks,function(fn,callback){if(fn){fn(function(err){var args=Array.prototype.slice.call(arguments,1);if(args.length<=1){args=args[0]}callback.call(null,err,args)})}},callback)}else{var results={};async.forEach(_keys(tasks),function(k,callback){tasks[k](function(err){var args=Array.prototype.slice.call(arguments,1);if(args.length<=1){args=args[0]}results[k]=args;callback(err)})},function(err){callback(err,results)})}};async.series=function(tasks,callback){callback=callback||function(){};if(tasks.constructor===Array){async.mapSeries(tasks,function(fn,callback){if(fn){fn(function(err){var args=Array.prototype.slice.call(arguments,1);if(args.length<=1){args=args[0]}callback.call(null,err,args)})}},callback)}else{var results={};async.forEachSeries(_keys(tasks),function(k,callback){tasks[k](function(err){var args=Array.prototype.slice.call(arguments,1);if(args.length<=1){args=args[0]}results[k]=args;callback(err)})},function(err){callback(err,results)})}};async.iterator=function(tasks){var makeCallback=function(index){var fn=function(){if(tasks.length){tasks[index].apply(null,arguments)}return fn.next()};fn.next=function(){return index<tasks.length-1?makeCallback(index+1):null};return fn};return makeCallback(0)};async.apply=function(fn){var args=Array.prototype.slice.call(arguments,1);return function(){return fn.apply(null,args.concat(Array.prototype.slice.call(arguments)))}};var _concat=function(eachfn,arr,fn,callback){var r=[];eachfn(arr,function(x,cb){fn(x,function(err,y){r=r.concat(y||[]);cb(err)})},function(err){callback(err,r)})};async.concat=doParallel(_concat);async.concatSeries=doSeries(_concat);async.whilst=function(test,iterator,callback){if(test()){iterator(function(err){if(err){return callback(err)}async.whilst(test,iterator,callback)})}else{callback()}};async.until=function(test,iterator,callback){if(!test()){iterator(function(err){if(err){return callback(err)}async.until(test,iterator,callback)})}else{callback()}};async.queue=function(worker,concurrency){var workers=0;var q={tasks:[],concurrency:concurrency,saturated:null,empty:null,drain:null,push:function(data,callback){if(data.constructor!==Array){data=[data]}_forEach(data,function(task){q.tasks.push({data:task,callback:typeof callback==="function"?callback:null});if(q.saturated&&q.tasks.length==concurrency){q.saturated()}async.nextTick(q.process)})},process:function(){if(workers<q.concurrency&&q.tasks.length){var task=q.tasks.shift();if(q.empty&&q.tasks.length==0)q.empty();workers+=1;worker(task.data,function(){workers-=1;if(task.callback){task.callback.apply(task,arguments)}if(q.drain&&q.tasks.length+workers==0)q.drain();q.process()})}},length:function(){return q.tasks.length},running:function(){return workers}};return q};var _console_fn=function(name){return function(fn){var args=Array.prototype.slice.call(arguments,1);fn.apply(null,args.concat([function(err){var args=Array.prototype.slice.call(arguments,1);if(typeof console!=="undefined"){if(err){if(console.error){console.error(err)}}else if(console[name]){_forEach(args,function(x){console[name](x)})}}}]))}};async.log=_console_fn("log");async.dir=_console_fn("dir");async.memoize=function(fn,hasher){var memo={};var queues={};hasher=hasher||function(x){return x};var memoized=function(){var args=Array.prototype.slice.call(arguments);var callback=args.pop();var key=hasher.apply(null,args);if(key in memo){callback.apply(null,memo[key])}else if(key in queues){queues[key].push(callback)}else{queues[key]=[callback];fn.apply(null,args.concat([function(){memo[key]=arguments;var q=queues[key];delete queues[key];for(var i=0,l=q.length;i<l;i++){q[i].apply(null,arguments)}}]))}};memoized.unmemoized=fn;return memoized};async.unmemoize=function(fn){return function(){return(fn.unmemoized||fn).apply(null,arguments)}}})()});require.define("/lib/container/inspectselect.js",function(require,module,exports,__dirname,__filename,process,global){var _=require("lodash");module.exports=parse;var chunkers=[{name:"tagname",regexp:/^(\*|\w+)/,mapper:function(val,map){map.tagname=val}},{name:"classnames",regexp:/^\.\w+/,mapper:function(val,map){map.classnames||(map.classnames={});map.classnames[val.replace(/^\./,"")]=true}},{name:"id",regexp:/^#\w+/,mapper:function(val,map){map.id=val.replace(/^#/,"")}},{name:"quarryid",regexp:/^=[\w-]+/,mapper:function(val,map){map.quarryid=val.replace(/^=/,"")}},{name:"hardlink",regexp:/^=\>[\w-]*/,mapper:function(val,map){map.hardlink=val.replace(/^=\>/,"")}},{name:"softlink",regexp:/^=\~[\w-]*/,mapper:function(val,map){map.softlink=val.replace(/^=\~/,"")}},{name:"modifier",regexp:/^:\w+/,mapper:function(val,map){map.modifier||(map.modifier={});map.modifier[val.replace(/^:/,"")]=true}},{name:"attr",regexp:/^\[.*?["']?.*?["']?\]/,mapper:function(val,map){map.attr||(map.attr=[]);var match=val.match(/\[(.*?)([=><\^\|\*\~\$\!]+)["']?(.*?)["']?\]/);if(match){map.attr.push({field:match[1],operator:match[2],value:match[3]})}else{map.attr.push({field:attrString.replace(/^\[/,"").replace(/\]$/,"")})}}},{name:"splitter",regexp:/^[ ,<>]+/,mapper:function(val,map){map.splitter=val.replace(/\s+/g,"")}}];function parseChunks(selector){var lastMatch=null;var workingString=selector?selector:"";var lastString="";var chunks=[];var matchNextChunk=function(){lastMatch=null;for(var i in chunkers){var chunker=chunkers[i];if(lastMatch=workingString.match(chunker.regexp)){chunks.push(_.extend({value:lastMatch[0]},chunker));workingString=workingString.replace(lastMatch[0],"");return true}}return false};while(matchNextChunk()){if(lastString==workingString){break}}return chunks}function new_selector(){return{classnames:{},attr:[],modifier:{}}}function parse(selector_string){if(typeof selector_string!=="string"){throw new Error("selector must be a string")}var chunks=parseChunks(selector_string);var phases=[];var currentPhase=[];var currentSelector=new_selector();var addCurrentPhase=function(){if(currentPhase.length>0){phases.push(currentPhase)}currentPhase=[]};var addCurrentSelector=function(){if(_.keys(currentSelector).length>0){currentPhase.push(currentSelector)}currentSelector=new_selector()};var addChunkToSelector=function(chunk,selector){chunk.mapper.apply(null,[chunk.value,selector])};_.each(chunks,function(chunk,index){if(chunk.name=="splitter"&&chunk.value.match(/,/)){addCurrentSelector();addCurrentPhase()}else{if(chunk.name=="splitter"&&index>0){addCurrentSelector()}addChunkToSelector(chunk,currentSelector)}});addCurrentSelector();addCurrentPhase();return phases}});require.define("/lib/container/find.js",function(require,module,exports,__dirname,__filename,process,global){var _=require("lodash");module.exports=factory;function State(arr){this.count=arr.length;this.index=0;this.finished=false}State.prototype.next=function(){this.index++;if(this.index>=this.count){this.finished=true}};function factory(searchfn){return function(selectors,context){var final_state=new State(selectors);var final_results=context.spawn();_.each(selectors.reverse(),function(stage){final_state.next();var stage_results=context.spawn();_.each(stage,function(phase){var phase_context=context;var selector_state=new State(phase);_.each(phase,function(selector){selector_state.next();var results=searchfn(selector,phase_context);if(results.count()<=0){return false}if(!selector_state.finished){phase_context=results}else{stage_results.add(results)}return true})});if(stage_results.count()<=0){return false}if(!final_state.finished){context=stage_results}else{final_results=stage_results}});return final_results}}});require.define("/lib/container/search.js",function(require,module,exports,__dirname,__filename,process,global){var _=require("lodash");var utils=require("../utils");var async=require("async");module.exports.searcher=search;module.exports.compiler=compile;var attr_compare_functions={"=":function(check,target){return!_.isUndefined(check)&&check==target},"!=":function(check,target){return!_.isUndefined(check)&&check!=target},">":function(check,target){target=parseFloat(target);return!_.isUndefined(check)&&!isNaN(target)?check>target:false},">=":function(check,target){target=parseFloat(target);return!_.isUndefined(check)&&!isNaN(target)?check>=target:false},"<":function(check,target){target=parseFloat(target);return!_.isUndefined(check)&&!isNaN(target)?check<target:false},"<=":function(check,target){target=parseFloat(target);return!_.isUndefined(check)&&!isNaN(target)?check<=target:false},"^=":function(check,target){return!_.isUndefined(check)&&check.match(new RegExp("^"+utils.escapeRegexp(target),"i"))!=null},"$=":function(check,target){return!_.isUndefined(check)&&check.match(new RegExp(utils.escapeRegexp(target)+"$","i"))!=null},"~=":function(check,target){return!_.isUndefined(check)&&check.match(new RegExp("W"+utils.escapeRegexp(target)+"W","i"))!=null},"|=":function(check,target){return!_.isUndefined(check)&&check.match(new RegExp("^"+utils.escapeRegexp(target)+"-","i"))!=null},"*=":function(check,target){return!_.isUndefined(check)&&check.match(new RegExp(utils.escapeRegexp(target),"i"))!=null}};function compile(selector){return function(container){if(selector.tagname=="*"){return true}if(selector.id&&container.id()!=selector.id){return false}if(selector.quarryid&&container.quarryid()!=selector.quarryid){return false}if(selector.tagname&&container.tagname()!=selector.tagname){return false}if(selector.classnames){var container_classnames={};_.each(container.classnames(),function(classname){container_classnames[classname]=true});var all_classnames_present=_.all(_.keys(selector.classnames),function(classname){return container_classnames[classname]?true:false});if(!all_classnames_present){return false}}if(selector.attr){var all_attributes_passed=_.all(selector.attr,function(attr_filter){var check_value=container.attr(attr_filter.field);var operator_function=attr_compare_functions[attr_filter.operator];if(!attr_filter.value){return check_value!=null}else if(operator_function){return operator_function.apply(null,[check_value,attr_filter.value])}else{return false}});if(!all_attributes_passed){return false}}return true}}function search(selector,context){var selector_filter=compile(selector);var search_in=context;if(selector.splitter==">"){search_in=context.children()}else if(selector.splitter=="<"){throw new Error("we do not support the parent splitter at the moment")}else{search_in=context.descendents()}return search_in.filter(selector_filter)}});require.define("/lib/utils.js",function(require,module,exports,__dirname,__filename,process,global){var _=require("lodash");var url=require("url");var uuid=require("node-uuid");var utils=module.exports={};utils.quarryid=function(){return uuid.v1()};utils.littleid=function(){var pattern="xxxxxx";return pattern.replace(/[xy]/g,function(c){var r=Math.random()*16|0,v=c=="x"?r:r&3|8;return v.toString(16)})};utils.escapeRegexp=function(search){return search.replace(/([\!\$\(\)\*\+\.\/\:\=\?\[\\\]\^\{\|\}])/g,"\\$1")};utils.escape=function(html){return String(html).replace(/&(?!\w+;)/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")};utils.parseUrl=function(req){var parsed=req._parsedUrl;if(parsed&&parsed.href==req.url){return parsed}else{return req._parsedUrl=url.parse(req.url)}};utils.makeroute=function(parts,delimeter){var route=_.filter(parts||[],function(part){return _.isNumber(part)||!_.isEmpty(part)}).join("/");if(delimeter){route=route.replace(/\//g,delimeter);if(route.indexOf(delimeter)==0){route=route.substr(1)}}return route.replace(/\/\//g,"/")};utils.extend=extend;function extend(){var options,name,src,copy,copyIsArray,clone,target=arguments[0]||{},i=1,length=arguments.length,deep=true,toString=Object.prototype.toString,hasOwn=Object.prototype.hasOwnProperty,push=Array.prototype.push,slice=Array.prototype.slice,trim=String.prototype.trim,indexOf=Array.prototype.indexOf,class2type={"[object Boolean]":"boolean","[object Number]":"number","[object String]":"string","[object Function]":"function","[object Array]":"array","[object Date]":"date","[object RegExp]":"regexp","[object Object]":"object"},jQuery={isFunction:function(obj){return jQuery.type(obj)==="function"},isArray:Array.isArray||function(obj){return jQuery.type(obj)==="array"},isWindow:function(obj){return obj!=null&&obj==obj.window},isNumeric:function(obj){return!isNaN(parseFloat(obj))&&isFinite(obj)},type:function(obj){return obj==null?String(obj):class2type[toString.call(obj)]||"object"},isPlainObject:function(obj){if(!obj||jQuery.type(obj)!=="object"||obj.nodeType){return false}try{if(obj.constructor&&!hasOwn.call(obj,"constructor")&&!hasOwn.call(obj.constructor.prototype,"isPrototypeOf")){return false}}catch(e){return false}var key;for(key in obj){}return key===undefined||hasOwn.call(obj,key)}};if(typeof target==="boolean"){deep=target;target=arguments[1]||{};i=2}if(typeof target!=="object"&&!jQuery.isFunction(target)){target={}}if(length===i){target=this;--i}for(i;i<length;i++){if((options=arguments[i])!=null){for(name in options){src=target[name];copy=options[name];if(target===copy){continue}if(deep&&copy&&(jQuery.isPlainObject(copy)||(copyIsArray=jQuery.isArray(copy)))){if(copyIsArray){copyIsArray=false;clone=src&&jQuery.isArray(src)?src:[]}else{clone=src&&jQuery.isPlainObject(src)?src:{}}target[name]=extend(deep,clone,copy)}else if(copy!==undefined){target[name]=copy}}}}return target}});require.define("url",function(require,module,exports,__dirname,__filename,process,global){var punycode={encode:function(s){return s}};exports.parse=urlParse;exports.resolve=urlResolve;exports.resolveObject=urlResolveObject;exports.format=urlFormat;function arrayIndexOf(array,subject){for(var i=0,j=array.length;i<j;i++){if(array[i]==subject)return i}return-1}var objectKeys=Object.keys||function objectKeys(object){if(object!==Object(object))throw new TypeError("Invalid object");var keys=[];for(var key in object)if(object.hasOwnProperty(key))keys[keys.length]=key;return keys};var protocolPattern=/^([a-z0-9.+-]+:)/i,portPattern=/:[0-9]+$/,delims=["<",">",'"',"`"," ","\r","\n","	"],unwise=["{","}","|","\\","^","~","[","]","`"].concat(delims),autoEscape=["'"],nonHostChars=["%","/","?",";","#"].concat(unwise).concat(autoEscape),nonAuthChars=["/","@","?","#"].concat(delims),hostnameMaxLen=255,hostnamePartPattern=/^[a-zA-Z0-9][a-z0-9A-Z_-]{0,62}$/,hostnamePartStart=/^([a-zA-Z0-9][a-z0-9A-Z_-]{0,62})(.*)$/,unsafeProtocol={javascript:true,"javascript:":true},hostlessProtocol={javascript:true,"javascript:":true},pathedProtocol={http:true,https:true,ftp:true,gopher:true,file:true,"http:":true,"ftp:":true,"gopher:":true,"file:":true},slashedProtocol={http:true,https:true,ftp:true,gopher:true,file:true,"http:":true,"https:":true,"ftp:":true,"gopher:":true,"file:":true},querystring=require("querystring");function urlParse(url,parseQueryString,slashesDenoteHost){if(url&&typeof url==="object"&&url.href)return url;if(typeof url!=="string"){throw new TypeError("Parameter 'url' must be a string, not "+typeof url)}var out={},rest=url;for(var i=0,l=rest.length;i<l;i++){if(arrayIndexOf(delims,rest.charAt(i))===-1)break}if(i!==0)rest=rest.substr(i);var proto=protocolPattern.exec(rest);if(proto){proto=proto[0];var lowerProto=proto.toLowerCase();out.protocol=lowerProto;rest=rest.substr(proto.length)}if(slashesDenoteHost||proto||rest.match(/^\/\/[^@\/]+@[^@\/]+/)){var slashes=rest.substr(0,2)==="//";if(slashes&&!(proto&&hostlessProtocol[proto])){rest=rest.substr(2);out.slashes=true}}if(!hostlessProtocol[proto]&&(slashes||proto&&!slashedProtocol[proto])){var atSign=arrayIndexOf(rest,"@");if(atSign!==-1){var hasAuth=true;for(var i=0,l=nonAuthChars.length;i<l;i++){var index=arrayIndexOf(rest,nonAuthChars[i]);if(index!==-1&&index<atSign){hasAuth=false;break}}if(hasAuth){out.auth=rest.substr(0,atSign);rest=rest.substr(atSign+1)}}var firstNonHost=-1;for(var i=0,l=nonHostChars.length;i<l;i++){var index=arrayIndexOf(rest,nonHostChars[i]);if(index!==-1&&(firstNonHost<0||index<firstNonHost))firstNonHost=index}if(firstNonHost!==-1){out.host=rest.substr(0,firstNonHost);rest=rest.substr(firstNonHost)}else{out.host=rest;rest=""}var p=parseHost(out.host);var keys=objectKeys(p);for(var i=0,l=keys.length;i<l;i++){var key=keys[i];out[key]=p[key]}out.hostname=out.hostname||"";if(out.hostname.length>hostnameMaxLen){out.hostname=""}else{var hostparts=out.hostname.split(/\./);for(var i=0,l=hostparts.length;i<l;i++){var part=hostparts[i];if(!part)continue;if(!part.match(hostnamePartPattern)){var newpart="";for(var j=0,k=part.length;j<k;j++){if(part.charCodeAt(j)>127){newpart+="x"}else{newpart+=part[j]}}if(!newpart.match(hostnamePartPattern)){var validParts=hostparts.slice(0,i);var notHost=hostparts.slice(i+1);var bit=part.match(hostnamePartStart);if(bit){validParts.push(bit[1]);notHost.unshift(bit[2])}if(notHost.length){rest="/"+notHost.join(".")+rest}out.hostname=validParts.join(".");break}}}}out.hostname=out.hostname.toLowerCase();var domainArray=out.hostname.split(".");var newOut=[];for(var i=0;i<domainArray.length;++i){var s=domainArray[i];newOut.push(s.match(/[^A-Za-z0-9_-]/)?"xn--"+punycode.encode(s):s)}out.hostname=newOut.join(".");out.host=(out.hostname||"")+(out.port?":"+out.port:"");out.href+=out.host}if(!unsafeProtocol[lowerProto]){for(var i=0,l=autoEscape.length;i<l;i++){var ae=autoEscape[i];var esc=encodeURIComponent(ae);if(esc===ae){esc=escape(ae)}rest=rest.split(ae).join(esc)}var chop=rest.length;for(var i=0,l=delims.length;i<l;i++){var c=arrayIndexOf(rest,delims[i]);if(c!==-1){chop=Math.min(c,chop)}}rest=rest.substr(0,chop)}var hash=arrayIndexOf(rest,"#");if(hash!==-1){out.hash=rest.substr(hash);rest=rest.slice(0,hash)}var qm=arrayIndexOf(rest,"?");if(qm!==-1){out.search=rest.substr(qm);out.query=rest.substr(qm+1);if(parseQueryString){out.query=querystring.parse(out.query)}rest=rest.slice(0,qm)}else if(parseQueryString){out.search="";out.query={}
}if(rest)out.pathname=rest;if(slashedProtocol[proto]&&out.hostname&&!out.pathname){out.pathname="/"}if(out.pathname||out.search){out.path=(out.pathname?out.pathname:"")+(out.search?out.search:"")}out.href=urlFormat(out);return out}function urlFormat(obj){if(typeof obj==="string")obj=urlParse(obj);var auth=obj.auth||"";if(auth){auth=auth.split("@").join("%40");for(var i=0,l=nonAuthChars.length;i<l;i++){var nAC=nonAuthChars[i];auth=auth.split(nAC).join(encodeURIComponent(nAC))}auth+="@"}var protocol=obj.protocol||"",host=obj.host!==undefined?auth+obj.host:obj.hostname!==undefined?auth+obj.hostname+(obj.port?":"+obj.port:""):false,pathname=obj.pathname||"",query=obj.query&&(typeof obj.query==="object"&&objectKeys(obj.query).length?querystring.stringify(obj.query):"")||"",search=obj.search||query&&"?"+query||"",hash=obj.hash||"";if(protocol&&protocol.substr(-1)!==":")protocol+=":";if(obj.slashes||(!protocol||slashedProtocol[protocol])&&host!==false){host="//"+(host||"");if(pathname&&pathname.charAt(0)!=="/")pathname="/"+pathname}else if(!host){host=""}if(hash&&hash.charAt(0)!=="#")hash="#"+hash;if(search&&search.charAt(0)!=="?")search="?"+search;return protocol+host+pathname+search+hash}function urlResolve(source,relative){return urlFormat(urlResolveObject(source,relative))}function urlResolveObject(source,relative){if(!source)return relative;source=urlParse(urlFormat(source),false,true);relative=urlParse(urlFormat(relative),false,true);source.hash=relative.hash;if(relative.href===""){source.href=urlFormat(source);return source}if(relative.slashes&&!relative.protocol){relative.protocol=source.protocol;if(slashedProtocol[relative.protocol]&&relative.hostname&&!relative.pathname){relative.path=relative.pathname="/"}relative.href=urlFormat(relative);return relative}if(relative.protocol&&relative.protocol!==source.protocol){if(!slashedProtocol[relative.protocol]){relative.href=urlFormat(relative);return relative}source.protocol=relative.protocol;if(!relative.host&&!hostlessProtocol[relative.protocol]){var relPath=(relative.pathname||"").split("/");while(relPath.length&&!(relative.host=relPath.shift()));if(!relative.host)relative.host="";if(!relative.hostname)relative.hostname="";if(relPath[0]!=="")relPath.unshift("");if(relPath.length<2)relPath.unshift("");relative.pathname=relPath.join("/")}source.pathname=relative.pathname;source.search=relative.search;source.query=relative.query;source.host=relative.host||"";source.auth=relative.auth;source.hostname=relative.hostname||relative.host;source.port=relative.port;if(source.pathname!==undefined||source.search!==undefined){source.path=(source.pathname?source.pathname:"")+(source.search?source.search:"")}source.slashes=source.slashes||relative.slashes;source.href=urlFormat(source);return source}var isSourceAbs=source.pathname&&source.pathname.charAt(0)==="/",isRelAbs=relative.host!==undefined||relative.pathname&&relative.pathname.charAt(0)==="/",mustEndAbs=isRelAbs||isSourceAbs||source.host&&relative.pathname,removeAllDots=mustEndAbs,srcPath=source.pathname&&source.pathname.split("/")||[],relPath=relative.pathname&&relative.pathname.split("/")||[],psychotic=source.protocol&&!slashedProtocol[source.protocol];if(psychotic){delete source.hostname;delete source.port;if(source.host){if(srcPath[0]==="")srcPath[0]=source.host;else srcPath.unshift(source.host)}delete source.host;if(relative.protocol){delete relative.hostname;delete relative.port;if(relative.host){if(relPath[0]==="")relPath[0]=relative.host;else relPath.unshift(relative.host)}delete relative.host}mustEndAbs=mustEndAbs&&(relPath[0]===""||srcPath[0]==="")}if(isRelAbs){source.host=relative.host||relative.host===""?relative.host:source.host;source.hostname=relative.hostname||relative.hostname===""?relative.hostname:source.hostname;source.search=relative.search;source.query=relative.query;srcPath=relPath}else if(relPath.length){if(!srcPath)srcPath=[];srcPath.pop();srcPath=srcPath.concat(relPath);source.search=relative.search;source.query=relative.query}else if("search"in relative){if(psychotic){source.hostname=source.host=srcPath.shift();var authInHost=source.host&&arrayIndexOf(source.host,"@")>0?source.host.split("@"):false;if(authInHost){source.auth=authInHost.shift();source.host=source.hostname=authInHost.shift()}}source.search=relative.search;source.query=relative.query;if(source.pathname!==undefined||source.search!==undefined){source.path=(source.pathname?source.pathname:"")+(source.search?source.search:"")}source.href=urlFormat(source);return source}if(!srcPath.length){delete source.pathname;if(!source.search){source.path="/"+source.search}else{delete source.path}source.href=urlFormat(source);return source}var last=srcPath.slice(-1)[0];var hasTrailingSlash=(source.host||relative.host)&&(last==="."||last==="..")||last==="";var up=0;for(var i=srcPath.length;i>=0;i--){last=srcPath[i];if(last=="."){srcPath.splice(i,1)}else if(last===".."){srcPath.splice(i,1);up++}else if(up){srcPath.splice(i,1);up--}}if(!mustEndAbs&&!removeAllDots){for(;up--;up){srcPath.unshift("..")}}if(mustEndAbs&&srcPath[0]!==""&&(!srcPath[0]||srcPath[0].charAt(0)!=="/")){srcPath.unshift("")}if(hasTrailingSlash&&srcPath.join("/").substr(-1)!=="/"){srcPath.push("")}var isAbsolute=srcPath[0]===""||srcPath[0]&&srcPath[0].charAt(0)==="/";if(psychotic){source.hostname=source.host=isAbsolute?"":srcPath.length?srcPath.shift():"";var authInHost=source.host&&arrayIndexOf(source.host,"@")>0?source.host.split("@"):false;if(authInHost){source.auth=authInHost.shift();source.host=source.hostname=authInHost.shift()}}mustEndAbs=mustEndAbs||source.host&&srcPath.length;if(mustEndAbs&&!isAbsolute){srcPath.unshift("")}source.pathname=srcPath.join("/");if(source.pathname!==undefined||source.search!==undefined){source.path=(source.pathname?source.pathname:"")+(source.search?source.search:"")}source.auth=relative.auth||source.auth;source.slashes=source.slashes||relative.slashes;source.href=urlFormat(source);return source}function parseHost(host){var out={};var port=portPattern.exec(host);if(port){port=port[0];out.port=port.substr(1);host=host.substr(0,host.length-port.length)}if(host)out.hostname=host;return out}});require.define("querystring",function(require,module,exports,__dirname,__filename,process,global){var isArray=typeof Array.isArray==="function"?Array.isArray:function(xs){return Object.prototype.toString.call(xs)==="[object Array]"};var objectKeys=Object.keys||function objectKeys(object){if(object!==Object(object))throw new TypeError("Invalid object");var keys=[];for(var key in object)if(object.hasOwnProperty(key))keys[keys.length]=key;return keys};exports.version="0.3.1";var toString=Object.prototype.toString;var notint=/[^0-9]/;exports.parse=function(str){if(null==str||""==str)return{};function promote(parent,key){if(parent[key].length==0)return parent[key]={};var t={};for(var i in parent[key])t[i]=parent[key][i];parent[key]=t;return t}return String(str).split("&").reduce(function(ret,pair){try{pair=decodeURIComponent(pair.replace(/\+/g," "))}catch(e){}var eql=pair.indexOf("="),brace=lastBraceInKey(pair),key=pair.substr(0,brace||eql),val=pair.substr(brace||eql,pair.length),val=val.substr(val.indexOf("=")+1,val.length),parent=ret;if(""==key)key=pair,val="";if(~key.indexOf("]")){var parts=key.split("["),len=parts.length,last=len-1;function parse(parts,parent,key){var part=parts.shift();if(!part){if(isArray(parent[key])){parent[key].push(val)}else if("object"==typeof parent[key]){parent[key]=val}else if("undefined"==typeof parent[key]){parent[key]=val}else{parent[key]=[parent[key],val]}}else{obj=parent[key]=parent[key]||[];if("]"==part){if(isArray(obj)){if(""!=val)obj.push(val)}else if("object"==typeof obj){obj[objectKeys(obj).length]=val}else{obj=parent[key]=[parent[key],val]}}else if(~part.indexOf("]")){part=part.substr(0,part.length-1);if(notint.test(part)&&isArray(obj))obj=promote(parent,key);parse(parts,obj,part)}else{if(notint.test(part)&&isArray(obj))obj=promote(parent,key);parse(parts,obj,part)}}}parse(parts,parent,"base")}else{if(notint.test(key)&&isArray(parent.base)){var t={};for(var k in parent.base)t[k]=parent.base[k];parent.base=t}set(parent.base,key,val)}return ret},{base:{}}).base};var stringify=exports.stringify=function(obj,prefix){if(isArray(obj)){return stringifyArray(obj,prefix)}else if("[object Object]"==toString.call(obj)){return stringifyObject(obj,prefix)}else if("string"==typeof obj){return stringifyString(obj,prefix)}else{return prefix}};function stringifyString(str,prefix){if(!prefix)throw new TypeError("stringify expects an object");return prefix+"="+encodeURIComponent(str)}function stringifyArray(arr,prefix){var ret=[];if(!prefix)throw new TypeError("stringify expects an object");for(var i=0;i<arr.length;i++){ret.push(stringify(arr[i],prefix+"[]"))}return ret.join("&")}function stringifyObject(obj,prefix){var ret=[],keys=objectKeys(obj),key;for(var i=0,len=keys.length;i<len;++i){key=keys[i];ret.push(stringify(obj[key],prefix?prefix+"["+encodeURIComponent(key)+"]":encodeURIComponent(key)))}return ret.join("&")}function set(obj,key,val){var v=obj[key];if(undefined===v){obj[key]=val}else if(isArray(v)){v.push(val)}else{obj[key]=[v,val]}}function lastBraceInKey(str){var len=str.length,brace,c;for(var i=0;i<len;++i){c=str[i];if("]"==c)brace=false;if("["==c)brace=true;if("="==c&&!brace)return i}}});require.define("/node_modules/node-uuid/package.json",function(require,module,exports,__dirname,__filename,process,global){module.exports={main:"./uuid.js"}});require.define("/node_modules/node-uuid/uuid.js",function(require,module,exports,__dirname,__filename,process,global){(function(){var _global=this;var _rng;if(typeof require=="function"){try{var _rb=require("crypto").randomBytes;_rng=_rb&&function(){return _rb(16)}}catch(e){}}if(!_rng&&_global.crypto&&crypto.getRandomValues){var _rnds8=new Uint8Array(16);_rng=function whatwgRNG(){crypto.getRandomValues(_rnds8);return _rnds8}}if(!_rng){var _rnds=new Array(16);_rng=function(){for(var i=0,r;i<16;i++){if((i&3)===0)r=Math.random()*4294967296;_rnds[i]=r>>>((i&3)<<3)&255}return _rnds}}var BufferClass=typeof Buffer=="function"?Buffer:Array;var _byteToHex=[];var _hexToByte={};for(var i=0;i<256;i++){_byteToHex[i]=(i+256).toString(16).substr(1);_hexToByte[_byteToHex[i]]=i}function parse(s,buf,offset){var i=buf&&offset||0,ii=0;buf=buf||[];s.toLowerCase().replace(/[0-9a-f]{2}/g,function(oct){if(ii<16){buf[i+ii++]=_hexToByte[oct]}});while(ii<16){buf[i+ii++]=0}return buf}function unparse(buf,offset){var i=offset||0,bth=_byteToHex;return bth[buf[i++]]+bth[buf[i++]]+bth[buf[i++]]+bth[buf[i++]]+"-"+bth[buf[i++]]+bth[buf[i++]]+"-"+bth[buf[i++]]+bth[buf[i++]]+"-"+bth[buf[i++]]+bth[buf[i++]]+"-"+bth[buf[i++]]+bth[buf[i++]]+bth[buf[i++]]+bth[buf[i++]]+bth[buf[i++]]+bth[buf[i++]]}var _seedBytes=_rng();var _nodeId=[_seedBytes[0]|1,_seedBytes[1],_seedBytes[2],_seedBytes[3],_seedBytes[4],_seedBytes[5]];var _clockseq=(_seedBytes[6]<<8|_seedBytes[7])&16383;var _lastMSecs=0,_lastNSecs=0;function v1(options,buf,offset){var i=buf&&offset||0;var b=buf||[];options=options||{};var clockseq=options.clockseq!=null?options.clockseq:_clockseq;var msecs=options.msecs!=null?options.msecs:(new Date).getTime();var nsecs=options.nsecs!=null?options.nsecs:_lastNSecs+1;var dt=msecs-_lastMSecs+(nsecs-_lastNSecs)/1e4;if(dt<0&&options.clockseq==null){clockseq=clockseq+1&16383}if((dt<0||msecs>_lastMSecs)&&options.nsecs==null){nsecs=0}if(nsecs>=1e4){throw new Error("uuid.v1(): Can't create more than 10M uuids/sec")}_lastMSecs=msecs;_lastNSecs=nsecs;_clockseq=clockseq;msecs+=122192928e5;var tl=((msecs&268435455)*1e4+nsecs)%4294967296;b[i++]=tl>>>24&255;b[i++]=tl>>>16&255;b[i++]=tl>>>8&255;b[i++]=tl&255;var tmh=msecs/4294967296*1e4&268435455;b[i++]=tmh>>>8&255;b[i++]=tmh&255;b[i++]=tmh>>>24&15|16;b[i++]=tmh>>>16&255;b[i++]=clockseq>>>8|128;b[i++]=clockseq&255;var node=options.node||_nodeId;for(var n=0;n<6;n++){b[i+n]=node[n]}return buf?buf:unparse(b)}function v4(options,buf,offset){var i=buf&&offset||0;if(typeof options=="string"){buf=options=="binary"?new BufferClass(16):null;options=null}options=options||{};var rnds=options.random||(options.rng||_rng)();rnds[6]=rnds[6]&15|64;rnds[8]=rnds[8]&63|128;if(buf){for(var ii=0;ii<16;ii++){buf[i+ii]=rnds[ii]}}return buf||unparse(rnds)}var uuid=v4;uuid.v1=v1;uuid.v4=v4;uuid.parse=parse;uuid.unparse=unparse;uuid.BufferClass=BufferClass;if(_global.define&&define.amd){define(function(){return uuid})}else if(typeof module!="undefined"&&module.exports){module.exports=uuid}else{var _previousRoot=_global.uuid;uuid.noConflict=function(){_global.uuid=_previousRoot;return uuid};_global.uuid=uuid}})()});require.define("crypto",function(require,module,exports,__dirname,__filename,process,global){module.exports=require("crypto-browserify")});require.define("/node_modules/crypto-browserify/package.json",function(require,module,exports,__dirname,__filename,process,global){module.exports={}});require.define("/node_modules/crypto-browserify/index.js",function(require,module,exports,__dirname,__filename,process,global){var sha=require("./sha");var rng=require("./rng");var md5=require("./md5");var algorithms={sha1:{hex:sha.hex_sha1,binary:sha.b64_sha1,ascii:sha.str_sha1},md5:{hex:md5.hex_md5,binary:md5.b64_md5,ascii:md5.any_md5}};function error(){var m=[].slice.call(arguments).join(" ");throw new Error([m,"we accept pull requests","http://github.com/dominictarr/crypto-browserify"].join("\n"))}exports.createHash=function(alg){alg=alg||"sha1";if(!algorithms[alg])error("algorithm:",alg,"is not yet supported");var s="";var _alg=algorithms[alg];return{update:function(data){s+=data;return this},digest:function(enc){enc=enc||"binary";var fn;if(!(fn=_alg[enc]))error("encoding:",enc,"is not yet supported for algorithm",alg);var r=fn(s);s=null;return r}}};exports.randomBytes=function(size,callback){if(callback&&callback.call){try{callback.call(this,undefined,rng(size))}catch(err){callback(err)}}else{return rng(size)}};["createCredentials","createHmac","createCypher","createCypheriv","createDecipher","createDecipheriv","createSign","createVerify","createDeffieHellman","pbkdf2"].forEach(function(name){exports[name]=function(){error("sorry,",name,"is not implemented yet")}})});require.define("/node_modules/crypto-browserify/sha.js",function(require,module,exports,__dirname,__filename,process,global){exports.hex_sha1=hex_sha1;exports.b64_sha1=b64_sha1;exports.str_sha1=str_sha1;exports.hex_hmac_sha1=hex_hmac_sha1;exports.b64_hmac_sha1=b64_hmac_sha1;exports.str_hmac_sha1=str_hmac_sha1;var hexcase=0;var b64pad="";var chrsz=8;function hex_sha1(s){return binb2hex(core_sha1(str2binb(s),s.length*chrsz))}function b64_sha1(s){return binb2b64(core_sha1(str2binb(s),s.length*chrsz))}function str_sha1(s){return binb2str(core_sha1(str2binb(s),s.length*chrsz))}function hex_hmac_sha1(key,data){return binb2hex(core_hmac_sha1(key,data))}function b64_hmac_sha1(key,data){return binb2b64(core_hmac_sha1(key,data))}function str_hmac_sha1(key,data){return binb2str(core_hmac_sha1(key,data))}function sha1_vm_test(){return hex_sha1("abc")=="a9993e364706816aba3e25717850c26c9cd0d89d"}function core_sha1(x,len){x[len>>5]|=128<<24-len%32;x[(len+64>>9<<4)+15]=len;var w=Array(80);var a=1732584193;var b=-271733879;var c=-1732584194;var d=271733878;var e=-1009589776;for(var i=0;i<x.length;i+=16){var olda=a;var oldb=b;var oldc=c;var oldd=d;var olde=e;for(var j=0;j<80;j++){if(j<16)w[j]=x[i+j];else w[j]=rol(w[j-3]^w[j-8]^w[j-14]^w[j-16],1);var t=safe_add(safe_add(rol(a,5),sha1_ft(j,b,c,d)),safe_add(safe_add(e,w[j]),sha1_kt(j)));e=d;d=c;c=rol(b,30);b=a;a=t}a=safe_add(a,olda);b=safe_add(b,oldb);c=safe_add(c,oldc);d=safe_add(d,oldd);e=safe_add(e,olde)}return Array(a,b,c,d,e)}function sha1_ft(t,b,c,d){if(t<20)return b&c|~b&d;if(t<40)return b^c^d;if(t<60)return b&c|b&d|c&d;return b^c^d}function sha1_kt(t){return t<20?1518500249:t<40?1859775393:t<60?-1894007588:-899497514}function core_hmac_sha1(key,data){var bkey=str2binb(key);if(bkey.length>16)bkey=core_sha1(bkey,key.length*chrsz);var ipad=Array(16),opad=Array(16);for(var i=0;i<16;i++){ipad[i]=bkey[i]^909522486;opad[i]=bkey[i]^1549556828}var hash=core_sha1(ipad.concat(str2binb(data)),512+data.length*chrsz);return core_sha1(opad.concat(hash),512+160)}function safe_add(x,y){var lsw=(x&65535)+(y&65535);var msw=(x>>16)+(y>>16)+(lsw>>16);return msw<<16|lsw&65535}function rol(num,cnt){return num<<cnt|num>>>32-cnt}function str2binb(str){var bin=Array();var mask=(1<<chrsz)-1;for(var i=0;i<str.length*chrsz;i+=chrsz)bin[i>>5]|=(str.charCodeAt(i/chrsz)&mask)<<32-chrsz-i%32;return bin}function binb2str(bin){var str="";var mask=(1<<chrsz)-1;for(var i=0;i<bin.length*32;i+=chrsz)str+=String.fromCharCode(bin[i>>5]>>>32-chrsz-i%32&mask);return str}function binb2hex(binarray){var hex_tab=hexcase?"0123456789ABCDEF":"0123456789abcdef";var str="";for(var i=0;i<binarray.length*4;i++){str+=hex_tab.charAt(binarray[i>>2]>>(3-i%4)*8+4&15)+hex_tab.charAt(binarray[i>>2]>>(3-i%4)*8&15)}return str}function binb2b64(binarray){var tab="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";var str="";for(var i=0;i<binarray.length*4;i+=3){var triplet=(binarray[i>>2]>>8*(3-i%4)&255)<<16|(binarray[i+1>>2]>>8*(3-(i+1)%4)&255)<<8|binarray[i+2>>2]>>8*(3-(i+2)%4)&255;for(var j=0;j<4;j++){if(i*8+j*6>binarray.length*32)str+=b64pad;else str+=tab.charAt(triplet>>6*(3-j)&63)}}return str}});require.define("/node_modules/crypto-browserify/rng.js",function(require,module,exports,__dirname,__filename,process,global){(function(){var _global=this;var mathRNG,whatwgRNG;mathRNG=function(size){var bytes=new Array(size);var r;for(var i=0,r;i<size;i++){if((i&3)==0)r=Math.random()*4294967296;bytes[i]=r>>>((i&3)<<3)&255}return bytes};if(_global.crypto&&crypto.getRandomValues){var _rnds=new Uint32Array(4);whatwgRNG=function(size){var bytes=new Array(size);crypto.getRandomValues(_rnds);for(var c=0;c<size;c++){bytes[c]=_rnds[c>>2]>>>(c&3)*8&255}return bytes}}module.exports=whatwgRNG||mathRNG})()});require.define("/node_modules/crypto-browserify/md5.js",function(require,module,exports,__dirname,__filename,process,global){var hexcase=0;var b64pad="";function hex_md5(s){return rstr2hex(rstr_md5(str2rstr_utf8(s)))}function b64_md5(s){return rstr2b64(rstr_md5(str2rstr_utf8(s)))}function any_md5(s,e){return rstr2any(rstr_md5(str2rstr_utf8(s)),e)}function hex_hmac_md5(k,d){return rstr2hex(rstr_hmac_md5(str2rstr_utf8(k),str2rstr_utf8(d)))}function b64_hmac_md5(k,d){return rstr2b64(rstr_hmac_md5(str2rstr_utf8(k),str2rstr_utf8(d)))}function any_hmac_md5(k,d,e){return rstr2any(rstr_hmac_md5(str2rstr_utf8(k),str2rstr_utf8(d)),e)}function md5_vm_test(){return hex_md5("abc").toLowerCase()=="900150983cd24fb0d6963f7d28e17f72"}function rstr_md5(s){return binl2rstr(binl_md5(rstr2binl(s),s.length*8))}function rstr_hmac_md5(key,data){var bkey=rstr2binl(key);if(bkey.length>16)bkey=binl_md5(bkey,key.length*8);var ipad=Array(16),opad=Array(16);for(var i=0;i<16;i++){ipad[i]=bkey[i]^909522486;opad[i]=bkey[i]^1549556828}var hash=binl_md5(ipad.concat(rstr2binl(data)),512+data.length*8);return binl2rstr(binl_md5(opad.concat(hash),512+128))}function rstr2hex(input){try{hexcase}catch(e){hexcase=0}var hex_tab=hexcase?"0123456789ABCDEF":"0123456789abcdef";var output="";var x;for(var i=0;i<input.length;i++){x=input.charCodeAt(i);output+=hex_tab.charAt(x>>>4&15)+hex_tab.charAt(x&15)}return output}function rstr2b64(input){try{b64pad}catch(e){b64pad=""}var tab="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";var output="";var len=input.length;for(var i=0;i<len;i+=3){var triplet=input.charCodeAt(i)<<16|(i+1<len?input.charCodeAt(i+1)<<8:0)|(i+2<len?input.charCodeAt(i+2):0);for(var j=0;j<4;j++){if(i*8+j*6>input.length*8)output+=b64pad;else output+=tab.charAt(triplet>>>6*(3-j)&63)}}return output}function rstr2any(input,encoding){var divisor=encoding.length;var i,j,q,x,quotient;var dividend=Array(Math.ceil(input.length/2));for(i=0;i<dividend.length;i++){dividend[i]=input.charCodeAt(i*2)<<8|input.charCodeAt(i*2+1)}var full_length=Math.ceil(input.length*8/(Math.log(encoding.length)/Math.log(2)));var remainders=Array(full_length);for(j=0;j<full_length;j++){quotient=Array();x=0;for(i=0;i<dividend.length;i++){x=(x<<16)+dividend[i];q=Math.floor(x/divisor);x-=q*divisor;if(quotient.length>0||q>0)quotient[quotient.length]=q}remainders[j]=x;dividend=quotient}var output="";for(i=remainders.length-1;i>=0;i--)output+=encoding.charAt(remainders[i]);return output}function str2rstr_utf8(input){var output="";var i=-1;var x,y;while(++i<input.length){x=input.charCodeAt(i);y=i+1<input.length?input.charCodeAt(i+1):0;if(55296<=x&&x<=56319&&56320<=y&&y<=57343){x=65536+((x&1023)<<10)+(y&1023);i++}if(x<=127)output+=String.fromCharCode(x);else if(x<=2047)output+=String.fromCharCode(192|x>>>6&31,128|x&63);else if(x<=65535)output+=String.fromCharCode(224|x>>>12&15,128|x>>>6&63,128|x&63);else if(x<=2097151)output+=String.fromCharCode(240|x>>>18&7,128|x>>>12&63,128|x>>>6&63,128|x&63)}return output}function str2rstr_utf16le(input){var output="";for(var i=0;i<input.length;i++)output+=String.fromCharCode(input.charCodeAt(i)&255,input.charCodeAt(i)>>>8&255);return output}function str2rstr_utf16be(input){var output="";for(var i=0;i<input.length;i++)output+=String.fromCharCode(input.charCodeAt(i)>>>8&255,input.charCodeAt(i)&255);return output}function rstr2binl(input){var output=Array(input.length>>2);for(var i=0;i<output.length;i++)output[i]=0;for(var i=0;i<input.length*8;i+=8)output[i>>5]|=(input.charCodeAt(i/8)&255)<<i%32;return output}function binl2rstr(input){var output="";for(var i=0;i<input.length*32;i+=8)output+=String.fromCharCode(input[i>>5]>>>i%32&255);return output}function binl_md5(x,len){x[len>>5]|=128<<len%32;x[(len+64>>>9<<4)+14]=len;var a=1732584193;var b=-271733879;var c=-1732584194;var d=271733878;for(var i=0;i<x.length;i+=16){var olda=a;var oldb=b;var oldc=c;var oldd=d;a=md5_ff(a,b,c,d,x[i+0],7,-680876936);d=md5_ff(d,a,b,c,x[i+1],12,-389564586);c=md5_ff(c,d,a,b,x[i+2],17,606105819);b=md5_ff(b,c,d,a,x[i+3],22,-1044525330);a=md5_ff(a,b,c,d,x[i+4],7,-176418897);d=md5_ff(d,a,b,c,x[i+5],12,1200080426);c=md5_ff(c,d,a,b,x[i+6],17,-1473231341);b=md5_ff(b,c,d,a,x[i+7],22,-45705983);a=md5_ff(a,b,c,d,x[i+8],7,1770035416);d=md5_ff(d,a,b,c,x[i+9],12,-1958414417);c=md5_ff(c,d,a,b,x[i+10],17,-42063);b=md5_ff(b,c,d,a,x[i+11],22,-1990404162);a=md5_ff(a,b,c,d,x[i+12],7,1804603682);d=md5_ff(d,a,b,c,x[i+13],12,-40341101);c=md5_ff(c,d,a,b,x[i+14],17,-1502002290);b=md5_ff(b,c,d,a,x[i+15],22,1236535329);a=md5_gg(a,b,c,d,x[i+1],5,-165796510);d=md5_gg(d,a,b,c,x[i+6],9,-1069501632);c=md5_gg(c,d,a,b,x[i+11],14,643717713);b=md5_gg(b,c,d,a,x[i+0],20,-373897302);a=md5_gg(a,b,c,d,x[i+5],5,-701558691);d=md5_gg(d,a,b,c,x[i+10],9,38016083);c=md5_gg(c,d,a,b,x[i+15],14,-660478335);b=md5_gg(b,c,d,a,x[i+4],20,-405537848);a=md5_gg(a,b,c,d,x[i+9],5,568446438);d=md5_gg(d,a,b,c,x[i+14],9,-1019803690);c=md5_gg(c,d,a,b,x[i+3],14,-187363961);b=md5_gg(b,c,d,a,x[i+8],20,1163531501);a=md5_gg(a,b,c,d,x[i+13],5,-1444681467);d=md5_gg(d,a,b,c,x[i+2],9,-51403784);c=md5_gg(c,d,a,b,x[i+7],14,1735328473);b=md5_gg(b,c,d,a,x[i+12],20,-1926607734);a=md5_hh(a,b,c,d,x[i+5],4,-378558);d=md5_hh(d,a,b,c,x[i+8],11,-2022574463);c=md5_hh(c,d,a,b,x[i+11],16,1839030562);b=md5_hh(b,c,d,a,x[i+14],23,-35309556);a=md5_hh(a,b,c,d,x[i+1],4,-1530992060);d=md5_hh(d,a,b,c,x[i+4],11,1272893353);c=md5_hh(c,d,a,b,x[i+7],16,-155497632);b=md5_hh(b,c,d,a,x[i+10],23,-1094730640);a=md5_hh(a,b,c,d,x[i+13],4,681279174);d=md5_hh(d,a,b,c,x[i+0],11,-358537222);c=md5_hh(c,d,a,b,x[i+3],16,-722521979);b=md5_hh(b,c,d,a,x[i+6],23,76029189);a=md5_hh(a,b,c,d,x[i+9],4,-640364487);d=md5_hh(d,a,b,c,x[i+12],11,-421815835);c=md5_hh(c,d,a,b,x[i+15],16,530742520);b=md5_hh(b,c,d,a,x[i+2],23,-995338651);a=md5_ii(a,b,c,d,x[i+0],6,-198630844);d=md5_ii(d,a,b,c,x[i+7],10,1126891415);c=md5_ii(c,d,a,b,x[i+14],15,-1416354905);b=md5_ii(b,c,d,a,x[i+5],21,-57434055);a=md5_ii(a,b,c,d,x[i+12],6,1700485571);d=md5_ii(d,a,b,c,x[i+3],10,-1894986606);c=md5_ii(c,d,a,b,x[i+10],15,-1051523);b=md5_ii(b,c,d,a,x[i+1],21,-2054922799);a=md5_ii(a,b,c,d,x[i+8],6,1873313359);d=md5_ii(d,a,b,c,x[i+15],10,-30611744);c=md5_ii(c,d,a,b,x[i+6],15,-1560198380);b=md5_ii(b,c,d,a,x[i+13],21,1309151649);a=md5_ii(a,b,c,d,x[i+4],6,-145523070);d=md5_ii(d,a,b,c,x[i+11],10,-1120210379);c=md5_ii(c,d,a,b,x[i+2],15,718787259);b=md5_ii(b,c,d,a,x[i+9],21,-343485551);a=safe_add(a,olda);b=safe_add(b,oldb);c=safe_add(c,oldc);d=safe_add(d,oldd)}return Array(a,b,c,d)}function md5_cmn(q,a,b,x,s,t){return safe_add(bit_rol(safe_add(safe_add(a,q),safe_add(x,t)),s),b)}function md5_ff(a,b,c,d,x,s,t){return md5_cmn(b&c|~b&d,a,b,x,s,t)}function md5_gg(a,b,c,d,x,s,t){return md5_cmn(b&d|c&~d,a,b,x,s,t)}function md5_hh(a,b,c,d,x,s,t){return md5_cmn(b^c^d,a,b,x,s,t)}function md5_ii(a,b,c,d,x,s,t){return md5_cmn(c^(b|~d),a,b,x,s,t)}function safe_add(x,y){var lsw=(x&65535)+(y&65535);var msw=(x>>16)+(y>>16)+(lsw>>16);return msw<<16|lsw&65535}function bit_rol(num,cnt){return num<<cnt|num>>>32-cnt}exports.hex_md5=hex_md5;exports.b64_md5=b64_md5;exports.any_md5=any_md5});require.define("/lib/container/xml.js",function(require,module,exports,__dirname,__filename,process,global){var _=require("lodash");module.exports.parse=fromXML;module.exports.stringify=toXML;var is_node=process&&process.env&&process.env.QUARRYSERVER?true:false;function null_filter(val){return!_.isUndefined(val)&&!_.isNull(val)}function data_factory(element){if(element.nodeType!=element.ELEMENT_NODE){return}var metafields={id:true,quarryid:true};var manualfields={tagname:true,"class":true};var data={attr:{},meta:{tagname:element.nodeName,classnames:(element.getAttribute("class")||"").split(/\s+/)},children:[]};_.each(metafields,function(v,metafield){data.meta[metafield]=element.getAttribute(metafield)||""});_.each(element.attributes,function(attr){if(!metafields[attr.name]&&!manualfields[attr.name]){data.attr[attr.name]=attr.value}});data.children=_.filter(_.map(element.childNodes,data_factory),null_filter);return data}function BrowserXMLParser(st){if(window&&typeof window.DOMParser!="undefined"){return function(xmlStr){var xmlDoc=(new window.DOMParser).parseFromString(xmlStr,"text/xml");return _.map(xmlDoc.childNodes,data_factory)}(st)}else if(window&&typeof window.ActiveXObject!="undefined"&&new window.ActiveXObject("Microsoft.XMLDOM")){return function(xmlStr){var xmlDoc=new window.ActiveXObject("Microsoft.XMLDOM");xmlDoc.async="false";xmlDoc.loadXML(xmlStr);return _.map(xmlDoc.childNodes,data_factory)}(st)}}function ServerXMLParser(st){var results=null;var evalst=["var xml = require('xmldom');","var DOMParser = xml.DOMParser;","var doc = new DOMParser().parseFromString(st);","results = _.map(doc.childNodes, data_factory);"].join("\n");try{eval(evalst)}catch(e){throw new Error(e)}return results}function fromXML(string){return is_node?ServerXMLParser(string):BrowserXMLParser(string)}function string_factory(data,depth){var meta=data.meta||{};var attr=data.attr||{};function get_indent_string(){var st="	";var ret="";for(var i=0;i<depth;i++){ret+=st}return ret}var pairs={id:meta.id,quarryid:meta.quarryid,"class":_.isArray(meta.classnames)?meta.classnames.join(" "):""};var pair_strings=[];_.each(attr,function(val,key){pairs[key]=_.isString(val)?val:""+val});_.each(pairs,function(value,field){if(!_.isEmpty(value)){pair_strings.push(field+'="'+value+'"')}});if(data.children&&data.children.length>0){var ret=get_indent_string()+"<"+meta.tagname+" "+pair_strings.join(" ")+">"+"\n";_.each(data.children,function(child){ret+=string_factory(child,depth+1)});ret+=get_indent_string()+"</"+meta.tagname+">"+"\n";return ret}else{return get_indent_string()+"<"+meta.tagname+" "+pair_strings.join(" ")+" />"+"\n"}}function toXML(data_array){return _.map(data_array,function(data){return string_factory(data,0)}).join("\n")}});require.define("/lib/contract.js",function(require,module,exports,__dirname,__filename,process,global){var _=require("lodash");var Contract=require("./contract/proto");var Request=require("./contract/request");var Response=require("./contract/response");module.exports={factory:factory,request:request,response:response};function factory(type){var ret=new Contract;type&&ret.setType(type);return ret}function request(data){return new Request(data)}function response(data){return Response.factory(data)}});require.define("/lib/contract/proto.js",function(require,module,exports,__dirname,__filename,process,global){var _=require("lodash");var util=require("util");var utils=require("../utils");var Request=require("./request");var Response=require("./response");var eyes=require("eyes");module.exports=Contract;function Contract(data){Request.apply(this,[data]);this.setHeader("content-type","quarry/contract");this.getHeader("x-contract-id")||this.setHeader("x-contract-id",utils.quarryid());this.getHeader("x-contract-type")||this.setHeader("x-contract-type","merge");this.getHeader("x-quarry-department")||this.setHeader("x-quarry-department","contract");this.setType("merge");this.method="post";this.children=[];this.printlog=[];this.debugcallbacks=[];this.setMaxListeners(1e3)}util.inherits(Contract,Request);Contract.prototype.toJSON=function(){var ret=Request.prototype.toJSON.apply(this);if(this.children.length==1&&this.children[0].getHeader("content-type")=="quarry/contract"){var firstreq=this.children[0];this.inject(firstreq);return firstreq.toJSON()}else{ret.body=_.map(this.children,function(child){return child.toJSON()})}return ret};Contract.prototype.ship=function(fn){var self=this;if(!this.supplychain){throw new Error("contract trying to ship with no supplychain")}var requestmap={};var mainres=Response.factory(function(){self.debugfn&&self.debugfn(mainres.toJSON());self.emit("ship",mainres);var answer=self.map_response(mainres);if(self.sortfn&&_.isFunction(answer.sort)){answer.sort(self.sortfn)}fn&&fn.apply(answer,[answer,mainres])});self.supplychain&&self.supplychain(self,mainres,function(){mainres.send404()});return this};Contract.prototype.sort=function(sortfn){sortfn&&(this.sortfn=sortfn);return this};Contract.prototype.debug=function(fn){var self=this;if(arguments.length>0){var debugid=utils.littleid();this.debugfn=fn;this.setHeader("x-quarry-debug-id",debugid);if(this.supplychain){this.on("ship",function(){self.supplychain.switchboard.cancel("debug:"+debugid)});this.supplychain.switchboard.listen("debug:"+debugid,fn)}return this}else{return this.getHeader("x-quarry-debug-id")}};Contract.prototype.title=function(title){arguments.length>0&&(this._title=title);return this};Contract.prototype.recurse=function(fn){function runres(req){fn&&fn(req);if(req.isContract()){_.each(req.children||[],function(subreq){runres(subreq)})}}runres(this)};Contract.prototype.expect=function(type){var self=this;if(!type){type="array"}function get_array_results(res){if(res.hasError()){return[]}var arr=[];var firstcontainertest=_.isArray(res.body)?res.body[0]:null;if(firstcontainertest&&firstcontainertest.meta){return res.body}res.recurse(function(res){if(res.isContainers()){arr=arr.concat(res.body)}});return arr}if(type.indexOf("container")==0&&this.container){this.map_response=function(res){var arr=get_array_results(res);return self.container.spawn(arr||[])}}else if(type.indexOf("array")==0){this.map_response=function(res){return get_array_results(res)}}else if(type.indexOf("first")==0){this.map_response=function(res){return(res.body||[])[0]}}return this};Contract.prototype.setType=function(type){this.setHeader("x-contract-type",type);return this};Contract.prototype.map=function(fn){var thischild=new Request(JSON.parse(JSON.stringify(this.toJSON())));this.setHeader("content-type","quarry/contract");this.getHeader("x-contract-id")||this.setHeader("x-contract-id",utils.quarryid());this.setType("pipe");this.method="post";this.children=[thischild];var mapcontract=new Request({method:"post",url:"/"});mapcontract.setHeader("content-type","quarry/map");mapcontract.setHeader("x-quarry-mapfn",fn.toString());mapcontract.setHeader("x-quarry-department","code");
this.add(mapcontract);return this};Contract.prototype.add=function(req){var self=this;req.getHeader("x-contract-id")||req.setHeader("x-contract-id",utils.quarryid());this.children.push(req);_.each(req.listeners("ship"),function(fn){self.on("ship",fn)});return this};Contract.prototype.map_response=function(res){return res}});require.define("util",function(require,module,exports,__dirname,__filename,process,global){var events=require("events");exports.isArray=isArray;exports.isDate=function(obj){return Object.prototype.toString.call(obj)==="[object Date]"};exports.isRegExp=function(obj){return Object.prototype.toString.call(obj)==="[object RegExp]"};exports.print=function(){};exports.puts=function(){};exports.debug=function(){};exports.inspect=function(obj,showHidden,depth,colors){var seen=[];var stylize=function(str,styleType){var styles={bold:[1,22],italic:[3,23],underline:[4,24],inverse:[7,27],white:[37,39],grey:[90,39],black:[30,39],blue:[34,39],cyan:[36,39],green:[32,39],magenta:[35,39],red:[31,39],yellow:[33,39]};var style={special:"cyan",number:"blue","boolean":"yellow",undefined:"grey","null":"bold",string:"green",date:"magenta",regexp:"red"}[styleType];if(style){return"["+styles[style][0]+"m"+str+"["+styles[style][1]+"m"}else{return str}};if(!colors){stylize=function(str,styleType){return str}}function format(value,recurseTimes){if(value&&typeof value.inspect==="function"&&value!==exports&&!(value.constructor&&value.constructor.prototype===value)){return value.inspect(recurseTimes)}switch(typeof value){case"undefined":return stylize("undefined","undefined");case"string":var simple="'"+JSON.stringify(value).replace(/^"|"$/g,"").replace(/'/g,"\\'").replace(/\\"/g,'"')+"'";return stylize(simple,"string");case"number":return stylize(""+value,"number");case"boolean":return stylize(""+value,"boolean")}if(value===null){return stylize("null","null")}var visible_keys=Object_keys(value);var keys=showHidden?Object_getOwnPropertyNames(value):visible_keys;if(typeof value==="function"&&keys.length===0){if(isRegExp(value)){return stylize(""+value,"regexp")}else{var name=value.name?": "+value.name:"";return stylize("[Function"+name+"]","special")}}if(isDate(value)&&keys.length===0){return stylize(value.toUTCString(),"date")}var base,type,braces;if(isArray(value)){type="Array";braces=["[","]"]}else{type="Object";braces=["{","}"]}if(typeof value==="function"){var n=value.name?": "+value.name:"";base=isRegExp(value)?" "+value:" [Function"+n+"]"}else{base=""}if(isDate(value)){base=" "+value.toUTCString()}if(keys.length===0){return braces[0]+base+braces[1]}if(recurseTimes<0){if(isRegExp(value)){return stylize(""+value,"regexp")}else{return stylize("[Object]","special")}}seen.push(value);var output=keys.map(function(key){var name,str;if(value.__lookupGetter__){if(value.__lookupGetter__(key)){if(value.__lookupSetter__(key)){str=stylize("[Getter/Setter]","special")}else{str=stylize("[Getter]","special")}}else{if(value.__lookupSetter__(key)){str=stylize("[Setter]","special")}}}if(visible_keys.indexOf(key)<0){name="["+key+"]"}if(!str){if(seen.indexOf(value[key])<0){if(recurseTimes===null){str=format(value[key])}else{str=format(value[key],recurseTimes-1)}if(str.indexOf("\n")>-1){if(isArray(value)){str=str.split("\n").map(function(line){return"  "+line}).join("\n").substr(2)}else{str="\n"+str.split("\n").map(function(line){return"   "+line}).join("\n")}}}else{str=stylize("[Circular]","special")}}if(typeof name==="undefined"){if(type==="Array"&&key.match(/^\d+$/)){return str}name=JSON.stringify(""+key);if(name.match(/^"([a-zA-Z_][a-zA-Z_0-9]*)"$/)){name=name.substr(1,name.length-2);name=stylize(name,"name")}else{name=name.replace(/'/g,"\\'").replace(/\\"/g,'"').replace(/(^"|"$)/g,"'");name=stylize(name,"string")}}return name+": "+str});seen.pop();var numLinesEst=0;var length=output.reduce(function(prev,cur){numLinesEst++;if(cur.indexOf("\n")>=0)numLinesEst++;return prev+cur.length+1},0);if(length>50){output=braces[0]+(base===""?"":base+"\n ")+" "+output.join(",\n  ")+" "+braces[1]}else{output=braces[0]+base+" "+output.join(", ")+" "+braces[1]}return output}return format(obj,typeof depth==="undefined"?2:depth)};function isArray(ar){return ar instanceof Array||Array.isArray(ar)||ar&&ar!==Object.prototype&&isArray(ar.__proto__)}function isRegExp(re){return re instanceof RegExp||typeof re==="object"&&Object.prototype.toString.call(re)==="[object RegExp]"}function isDate(d){if(d instanceof Date)return true;if(typeof d!=="object")return false;var properties=Date.prototype&&Object_getOwnPropertyNames(Date.prototype);var proto=d.__proto__&&Object_getOwnPropertyNames(d.__proto__);return JSON.stringify(proto)===JSON.stringify(properties)}function pad(n){return n<10?"0"+n.toString(10):n.toString(10)}var months=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];function timestamp(){var d=new Date;var time=[pad(d.getHours()),pad(d.getMinutes()),pad(d.getSeconds())].join(":");return[d.getDate(),months[d.getMonth()],time].join(" ")}exports.log=function(msg){};exports.pump=null;var Object_keys=Object.keys||function(obj){var res=[];for(var key in obj)res.push(key);return res};var Object_getOwnPropertyNames=Object.getOwnPropertyNames||function(obj){var res=[];for(var key in obj){if(Object.hasOwnProperty.call(obj,key))res.push(key)}return res};var Object_create=Object.create||function(prototype,properties){var object;if(prototype===null){object={__proto__:null}}else{if(typeof prototype!=="object"){throw new TypeError("typeof prototype["+typeof prototype+"] != 'object'")}var Type=function(){};Type.prototype=prototype;object=new Type;object.__proto__=prototype}if(typeof properties!=="undefined"&&Object.defineProperties){Object.defineProperties(object,properties)}return object};exports.inherits=function(ctor,superCtor){ctor.super_=superCtor;ctor.prototype=Object_create(superCtor.prototype,{constructor:{value:ctor,enumerable:false,writable:true,configurable:true}})};var formatRegExp=/%[sdj%]/g;exports.format=function(f){if(typeof f!=="string"){var objects=[];for(var i=0;i<arguments.length;i++){objects.push(exports.inspect(arguments[i]))}return objects.join(" ")}var i=1;var args=arguments;var len=args.length;var str=String(f).replace(formatRegExp,function(x){if(x==="%%")return"%";if(i>=len)return x;switch(x){case"%s":return String(args[i++]);case"%d":return Number(args[i++]);case"%j":return JSON.stringify(args[i++]);default:return x}});for(var x=args[i];i<len;x=args[++i]){if(x===null||typeof x!=="object"){str+=" "+x}else{str+=" "+exports.inspect(x)}}return str}});require.define("/lib/contract/request.js",function(require,module,exports,__dirname,__filename,process,global){var util=require("util");var Message=require("./message");var url=require("url");var utils=require("../utils");module.exports=Request;function Request(data){data||(data={});Message.apply(this,[data]);this.url=data.url||"/";this.method=data.method||"get";this.query=data.query||{};if(this.url.indexOf("?")>=0){var parts=this.url.split("?");_.extend(this.query,url.parse(this.url,true).query);this.url=parts[0];this.setHeader("x-query-string",parts[1])}}util.inherits(Request,Message);Request.prototype.toJSON=function(){var ret=Message.prototype.toJSON.apply(this);ret.url=this.url;ret.method=this.method;ret.query=this.query;ret.headers["x-quarry-url"]=ret.url;return ret};Request.prototype.clone=function(){return new Request(this.toJSON())};Request.prototype.parseurl=function(url){if(url.match(/^\w+:\//)){var parts=url.split(":");var department=parts.shift();this.setHeader("x-quarry-department",parts.shift());this.url=parts.join(":")}else{this.url=url}return this};Request.prototype.isContract=function(){return this.getHeader("content-type")=="quarry/contract"};Request.prototype.summary=function(){return this.method.toUpperCase()+" "+(this.getHeader("x-quarry-department")||"warehouse")+":"+(this.getHeader("x-quarry-url")||this.url)};Request.prototype.skeleton=function(){return{url:this.url,method:this.method,query:this.query}};Request.prototype.has_debug=function(){return this.getHeader("x-quarry-debug-id")!=null};Request.prototype.routingpacket=function(){return{url:this.url,method:this.method,contenttype:this.getHeader("content-type"),department:this.getHeader("x-quarry-department")||"warehouse",stackid:this.getHeader("x-quarry-stackid"),debugid:this.getHeader("x-quarry-debug-id"),flags:this.getHeader("x-quarry-flags")||{}}};Request.prototype.inject=function(req){req.setHeader("x-json-quarry-user",this.getHeader("x-json-quarry-user"));req.setHeader("x-quarry-bayid",this.getHeader("x-quarry-bayid"));req.setHeader("x-quarry-resolveid",this.getHeader("x-quarry-resolveid"));req.setHeader("x-json-quarry-project",this.getHeader("x-json-quarry-project"));req.setHeader("x-quarry-debug-id",this.getHeader("x-quarry-debug-id"));return this}});require.define("/lib/contract/message.js",function(require,module,exports,__dirname,__filename,process,global){var _=require("lodash");var util=require("util");var EventEmitter=require("events").EventEmitter;var utils=require("../utils");module.exports=Message;function Message(data){data||(data={});EventEmitter.call(this);this.headers=data.headers||{};this.body=data.body||null;this.headerSent=false}util.inherits(Message,EventEmitter);Message.prototype.toJSON=function(){return{headers:this.headers,body:this.body}};Message.prototype.quarryid=function(){return this.getHeader("x-quarry-id")};Message.prototype.setHeader=function(name,value){if(arguments.length<2){throw new Error("`name` and `value` are required for setHeader().")}if(this.headerSent){throw new Error("Can't set headers after they are sent.")}var key=name.toLowerCase();this.headers=this.headers||{};this.headers[key]=value;return this};Message.prototype.getHeader=function(name){if(arguments.length<1){throw new Error("`name` is required for getHeader().")}if(!this.headers)return;var key=name.toLowerCase();var value=this.headers[key];if(!value){return value}if(name.indexOf("x-json")==0&&_.isString(value)){value=this.headers[key]=JSON.parse(value)}return value};Message.prototype.removeHeader=function(name){if(arguments.length<1){throw new Error("`name` is required for removeHeader().")}if(this.headerSent){throw new Error("Can't remove headers after they are sent.")}if(!this.headers)return;var key=name.toLowerCase();delete this.headers[key]}});require.define("/lib/contract/response.js",function(require,module,exports,__dirname,__filename,process,global){var util=require("util");var Message=require("./message");var _=require("lodash");module.exports=Response;function Response(data){Message.apply(this,[data]);this.statusCode=data?data.statusCode:200}Response.factory=function(data){var fn=null;if(_.isFunction(data)){fn=data;data=null}var ret=new Response(data);if(fn){ret.on("send",function(){fn(null,ret)})}return ret};util.inherits(Response,Message);Response.prototype.statusCode=200;Response.prototype.fill=function(data){_.extend(this,_.isString(data)?JSON.parse(data):data);this.send()};Response.prototype.update=function(data){_.extend(this,_.isString(data)?JSON.parse(data):data)};Response.prototype.send=function(body){arguments.length>0&&(this.body=body);this.emit("beforesend");this.emit("send");this.headerSent=true;return this};Response.prototype.containers=function(body){this.setHeader("content-type","quarry/containers");this.body=body;return this};Response.prototype.json=function(body){this.setHeader("content-type","application/json");this.body=body;return this};Response.prototype.send404=function(){this.statusCode=404;return this.send("resource not found")};Response.prototype.error=function(body){this.statusCode=500;return this.send(body)};Response.prototype.hasError=function(){return this.statusCode>=400||(this.getHeader("x-json-quarry-errors")||[]).length>0};Response.prototype.getError=function(){if(!this.hasError()){return null}return _.filter([this.body].concat(this.getHeader("x-json-quarry-errors")||[]),function(val){return!_.isEmpty(val)}).join(", ")};Response.prototype.toJSON=function(){var ret=Message.prototype.toJSON.apply(this);ret.statusCode=this.statusCode;return ret};Response.prototype.flatten=function(){var all=[];this.recurse(function(res){all.push(res)});return all};Response.prototype.recurse=function(fn){function runres(res){if(res.isMultipart()){_.each(res.body||[],function(subresbody){var subresponse=new Response(subresbody);runres(subresponse)})}else{fn&&fn(res)}}runres(this);return this};Response.prototype.isContainers=function(){return this.getHeader("content-type")=="quarry/containers"};Response.prototype.isMultipart=function(){return this.getHeader("content-type")=="quarry/multipart"||this.getHeader("content-type")=="quarry/contract"};Response.prototype.http_content_type=function(){var ret=this.getHeader("content-type")||"text/html";return ret.indexOf("quarry/")>=0?"application/json":ret};Response.prototype.add=function(res){if(!res){throw new Error("adding null response")}if(!this.body){this.body=[]}this.setHeader("content-type","quarry/multipart");if(!res.hasError()){this.body=this.body.concat(res.body)}else{var errors=this.getHeader("x-json-quarry-errors")||[];errors.push(res.body);this.statusCode=res.statusCode;this.setHeader("x-json-quarry-errors",errors)}return this};Response.prototype.summary=function(){return this.statusCode+" "+(this.hasError()?this.body:this.getHeader("content-type"))};Response.prototype.redirect=function(location){this.send("redirect:"+location)};Response.prototype.httpsend=function(res,body){_.each(this.headers,function(val,key){res.setHeader(key,val)});res.setHeader("content-type",this.http_content_type());res.send(body||this.body)}});require.define("/node_modules/eyes/package.json",function(require,module,exports,__dirname,__filename,process,global){module.exports={main:"./lib/eyes"}});require.define("/node_modules/eyes/lib/eyes.js",function(require,module,exports,__dirname,__filename,process,global){var eyes=exports,stack=[];eyes.defaults={styles:{all:"cyan",label:"underline",other:"inverted",key:"bold",special:"grey",string:"green",number:"magenta",bool:"blue",regexp:"green"},pretty:true,hideFunctions:false,showHidden:false,stream:process.stdout,maxLength:2048};eyes.inspector=function(options){var that=this;return function(obj,label,opts){return that.inspect.call(that,obj,label,merge(options||{},opts||{}))}};eyes.inspect=function(obj,label,options){options=merge(this.defaults,options||{});if(options.stream){return this.print(stringify(obj,options),label,options)}else{return stringify(obj,options)+(options.styles?"[39m":"")}};eyes.print=function(str,label,options){for(var c=0,i=0;i<str.length;i++){if(str.charAt(i)===""){i+=4}else if(c===options.maxLength){str=str.slice(0,i-1)+"";break}else{c++}}return options.stream.write.call(options.stream,(label?this.stylize(label,options.styles.label,options.styles)+": ":"")+this.stylize(str,options.styles.all,options.styles)+"[0m"+"\n")};eyes.stylize=function(str,style,styles){var codes={bold:[1,22],underline:[4,24],inverse:[7,27],cyan:[36,39],magenta:[35,39],blue:[34,39],yellow:[33,39],green:[32,39],red:[31,39],grey:[90,39]},endCode;if(style&&codes[style]){endCode=codes[style][1]===39&&styles.all?codes[styles.all][0]:codes[style][1];return"["+codes[style][0]+"m"+str+"["+endCode+"m"}else{return str}};function stringify(obj,options){var that=this,stylize=function(str,style){return eyes.stylize(str,options.styles[style],options.styles)},index,result;if((index=stack.indexOf(obj))!==-1){return stylize(new Array(stack.length-index+1).join("."),"special")}stack.push(obj);result=function(obj){switch(typeOf(obj)){case"string":obj=stringifyString(obj.indexOf("'")===-1?"'"+obj+"'":'"'+obj+'"');return stylize(obj,"string");case"regexp":return stylize("/"+obj.source+"/","regexp");case"number":return stylize(obj+"","number");case"function":return options.stream?stylize("Function","other"):"[Function]";case"null":return stylize("null","special");case"undefined":return stylize("undefined","special");case"boolean":return stylize(obj+"","bool");case"date":return stylize(obj.toUTCString());case"array":return stringifyArray(obj,options,stack.length);case"object":return stringifyObject(obj,options,stack.length)}}(obj);stack.pop();return result}function stringifyString(str,options){return str.replace(/\\/g,"\\\\").replace(/\n/g,"\\n").replace(/[\u0001-\u001F]/g,function(match){return"\\0"+match[0].charCodeAt(0).toString(8)})}function stringifyArray(ary,options,level){var out=[];var pretty=options.pretty&&(ary.length>4||ary.some(function(o){return o!==null&&typeof o==="object"&&Object.keys(o).length>0||Array.isArray(o)&&o.length>0}));var ws=pretty?"\n"+new Array(level*4+1).join(" "):" ";for(var i=0;i<ary.length;i++){out.push(stringify(ary[i],options))}if(out.length===0){return"[]"}else{return"["+ws+out.join(","+(pretty?ws:" "))+(pretty?ws.slice(0,-4):ws)+"]"}}function stringifyObject(obj,options,level){var out=[];var pretty=options.pretty&&(Object.keys(obj).length>2||Object.keys(obj).some(function(k){return typeof obj[k]==="object"}));var ws=pretty?"\n"+new Array(level*4+1).join(" "):" ";var keys=options.showHidden?Object.keys(obj):Object.getOwnPropertyNames(obj);keys.forEach(function(k){if(Object.prototype.hasOwnProperty.call(obj,k)&&!(obj[k]instanceof Function&&options.hideFunctions)){out.push(eyes.stylize(k,options.styles.key,options.styles)+": "+stringify(obj[k],options))}});if(out.length===0){return"{}"}else{return"{"+ws+out.join(","+(pretty?ws:" "))+(pretty?ws.slice(0,-4):ws)+"}"}}function typeOf(value){var s=typeof value,types=[Object,Array,String,RegExp,Number,Function,Boolean,Date];if(s==="object"||s==="function"){if(value){types.forEach(function(t){if(value instanceof t){s=t.name.toLowerCase()}})}else{s="null"}}return s}function merge(){var objs=Array.prototype.slice.call(arguments);var target={};objs.forEach(function(o){Object.keys(o).forEach(function(k){if(k==="styles"){if(!o.styles){target.styles=false}else{target.styles={};for(var s in o.styles){target.styles[s]=o.styles[s]}}}else{target[k]=o[k]}})});return target}});require.define("/lib/portal/wrapper.js",function(require,module,exports,__dirname,__filename,process,global){var _=require("lodash");var Portal=require("./proto");var EventEmitter=require("events").EventEmitter;module.exports={portal:portal,radio:radio};function portal(container){var ret={};var portals=_.map(container.containers(),function(c){var portal=new Portal;portal.attachcontainer(c);return portal});function factory(method){return function(){var args=_.toArray(arguments);_.each(portals,function(portal){portal[method].apply(portal,args)});return this}}_.each(["appended","saved","deleted","sync","raw","broadcastinstruction","radio","close"],function(method){ret[method]=factory(method)});_.extend(ret,EventEmitter.prototype);return ret}function radio(container){var ret={};var radios=_.map(container.containers(),function(c){var portal=new Portal;portal.attachcontainer(c);return portal.radio()});function factory(method){return function(){var args=_.toArray(arguments);_.each(radios,function(radio){radio[method].apply(radio,args)});return this}}_.each(["listen","listenonce","talk","close"],function(method){ret[method]=factory(method)});_.extend(ret,EventEmitter.prototype);return ret}});require.define("/lib/portal/proto.js",function(require,module,exports,__dirname,__filename,process,global){var util=require("util");var utils=require("../utils");var EventEmitter=require("events").EventEmitter;var inspectselect=require("../container/inspectselect");var Router=require("../container/router");var eyes=require("eyes");var _=require("lodash");var Message=require("./message");var Radio=require("./radio");module.exports=Portal;function Portal(){EventEmitter.call(this);this.stack={};this.donemessages={};this.depthmode=false}util.inherits(Portal,EventEmitter);Portal.prototype.attachcontainer=function(container){this.container=container;this.spawn=_.bind(container.spawn,container);this.switchboard=container.get_switchboard();this.router=Router(container.skeleton())};Portal.prototype.attach=function(skeleton,switchboard){this.skeleton=skeleton;switchboard&&(this.switchboard=switchboard);this.router=Router(this.skeleton)};function processselector(selectorstring,handler){var deepmode=false;var selector=null;if(selectorstring){var deepmode=true;if(selectorstring.indexOf(">")==0){selectorstring=selectorstring.substr(1);deepmode=false}if(selectorstring.indexOf(".")==0){selector={classname:selectorstring.substr(1)}}else{selector={tagname:selectorstring}}}var orighandler=handler;handler=function(message){orighandler(message,selector)};handler.deepmode=deepmode;return handler}function matchselector(target,selector){if(!selector){return true}else if(selector.tagname==target.tagname()){return true}else if(selector.classname&&target.hasClass(selector.classname)){return true}else{return false}}function targetportal(httpmethod){return function(selector,fn){var self=this;if(!fn){fn=selector;selector=null}if(!this.spawn){throw new Error("saved cannot run added without a spawn function")}var handler=processselector(selector,function(message,selector){var target=message.get_target();console.log("-------------------------------------------");console.log("-------------------------------------------");console.log("-------------------------------------------");console.log("TARGET PORTAL");eyes.inspect(target.toJSON());if(matchselector(target,selector)){fn(message.body,target)}});this._register(httpmethod,handler)}}function containerportal(httpmethod){return function(selector,fn){var self=this;if(!fn){fn=selector;selector=null}if(!this.spawn){throw new Error("appended cannot run added without a spawn function")}var handler=processselector(selector,function(message,selector){var containers=message.get_containers();var target=message.get_target();if(!selector){fn(containers);return}else{var test=handler.deepmode?containers.descendents():containers;var results=test.filter(function(container){return matchselector(container,selector)});results.count()>0&&fn(results,target)}});this._register(httpmethod,handler);return this}}Portal.prototype.appended=containerportal("post");Portal.prototype.saved=containerportal("put");Portal.prototype.deleted=targetportal("delete");var syncmethods={post:function(container,message){var messagetarget=message.get_target();var messagecontainers=message.get_containers();if(message.deepmode){var containertarget=container.find("="+messagetarget.quarryid());if(containertarget.empty()){if(messagetarget.tagname()=="supplychain"&&container.tagname()=="supplychain"){containertarget=container}}if(containertarget.count()>0){messagecontainers.full()&&containertarget.append(messagecontainers)}}else{if(container.quarryid()==messagetarget.quarryid()){messagecontainers.full()&&container.append(messagecontainers)}}},put:function(container,message){var messagetarget=message.get_target();if(message.deepmode){var containertarget=container.find("="+messagetarget.quarryid());var newcontainer=container.spawn(message.body);if(containertarget.count()>0){containertarget.inject(newcontainer)}}else{if(container.quarryid()==messagetarget.quarryid()){container.inject(message.body)}}},"delete":function(container,message){var messagetarget=message.get_target();if(message.deepmode){console.log("-------------------------------------------");console.log("-------------------------------------------");console.dir(message);var containerparent=container.find("="+messagetarget.meta("parent_id"));if(containerparent.count()>0){containerparent.removechildren(messagetarget)}else{var directchildren=container.find("> ="+messagetarget.quarryid());if(directchildren.full()){container.removechildren(directchildren)}}}else{if(container.quarryid()==messagetarget.meta("parent_id")){container.removechildren(messagetarget)}}}};Portal.prototype.sync=function(){var self=this;if(!this.container){return this}var deepmode=false;var callback=null;if(arguments.length==1){if(_.isBoolean(arguments[0])){deepmode=arguments[0]}else if(_.isFunction(arguments[0])){callback=arguments[0]}}else if(arguments.length==2){deepmode=arguments[0];callback=arguments[1]}this.raw(deepmode,function(message){message.deepmode=deepmode;syncmethods[message.method]&&syncmethods[message.method].apply(self,[self.container,message]);callback&&callback(message,self.container)});return this};Portal.prototype.raw=function(deepmode,fn){if(!fn){fn=deepmode;deepmode=false}fn.deepmode=deepmode;this._register("*",fn);return this};Portal.prototype.close=function(){var self=this;_.each(self.stack,function(route){_.each(self.stack[route],function(fn){self.switchboard.cancel(route,fn)})});this.stack={};return this};Portal.prototype._register=function(httpmethod,fn){var self=this;var usemethod=httpmethod&&httpmethod!="*";var routermethod=(fn.deepmode?"deep":"shallow")+(usemethod?"method":"");var route=self.router[routermethod].apply(self.router,[httpmethod]);self._listen(route,function(messagedata){var message=new Message(messagedata,self.spawn);fn(message)});return this};Portal.prototype.run_stack=function(route,message){var self=this;if(this.donemessages[message.id]){return}this.donemessages[message.id]=true;setTimeout(function(){delete self.donemessages[message.id]},1e3);_.each(this.stack[route],function(fn){fn&&fn(message)})};Portal.prototype._listen=function(route,fn){return this._prependlisten("portal:/",route,fn)};Portal.prototype._cancel=function(route,fn){this.switchboard._cancel(route,fn);return this};Portal.prototype._prependlisten=function(prepend,route,fn){var self=this;if(this.switchboard){if(!this.stack[route]){this.stack[route]=[fn];this.switchboard.listen(prepend+route,function(message){self.run_stack(route,message)})}else{this.stack[route].push(fn)}}return this};Portal.prototype._broadcast=function(route,message){return this._prependbroadcast("portal:/",route,message)};Portal.prototype._prependbroadcast=function(prepend,route,message){var self=this;if(this.switchboard){this.switchboard.broadcast.apply(this.switchboard,[prepend+route,message])}return this};Portal.prototype.broadcastinstruction=function(instruction){var self=this;var doneroutes={};_.each(["shallow","deep","shallowmethod","deepmethod"],function(routermode){var route=self.router[routermode].apply(self.router,[instruction.method]);if(!doneroutes[route]){doneroutes[route]=true;self._broadcast(route,instruction)}})};Portal.prototype.radio=function(){return new Radio(this)}});require.define("/lib/container/router.js",function(require,module,exports,__dirname,__filename,process,global){var utils=require("../utils");var _=require("lodash");module.exports=router;module.exports.url=url;function router(skeleton){if(!skeleton){return{}}var containerid=null;var portalparts=null;if(skeleton.tagname!="supplychain"){containerid=skeleton.quarryid;portalparts=skeleton.quarryportal}return{quarrysupplier:function(){return skeleton.quarrysupplier},quarrydepartment:function(){return skeleton.quarrydepartment},method:function(method,mode){if(!mode){mode="shallow"}return this[mode+"method"].apply(this,[method])},shallowmethod:function(method){return utils.makeroute([method,this.shallow()],".")},deepmethod:function(method){return utils.makeroute([method,this.deep()],".")},rpc:function(){return utils.makeroute([skeleton.quarrysupplier,containerid])},shallow:function(){return utils.makeroute([skeleton.quarrysupplier,containerid],".")},deep:function(){return utils.makeroute([skeleton.quarrysupplier].concat(portalparts||[]),".")}}}function url(stackpath){var route={department:"warehouse",url:"/"};if(_.isString(stackpath)){if(stackpath.match(/^\w+:/)){var parts=stackpath.split(":");route.department=parts.shift();route.url=parts.join(":")}else{route.url=stackpath}}else if(_.isObject(stackpath)){_.extend(route,stackpath)}return route}});require.define("/lib/portal/message.js",function(require,module,exports,__dirname,__filename,process,global){var util=require("util");var utils=require("../utils");var EventEmitter=require("events").EventEmitter;var _=require("lodash");module.exports=Message;function Message(content,spawn){EventEmitter.call(this);_.extend(this,content||{});this.content=content;this.spawn=spawn}util.inherits(Message,EventEmitter);Message.prototype.get_containers=function(){var data=this.headers["content-type"]=="quarry/containers"?this.content.body:[];return this.spawn(data)};Message.prototype.get_target=function(){var data=this.target?[{meta:this.target}]:[];return this.spawn(data)};Message.prototype.get_update=function(){var data=this.headers["content-type"]=="quarry/update"?data:[];return this.spawn(data)};Message.prototype.toJSON=function(){return this.content}});require.define("/lib/portal/radio.js",function(require,module,exports,__dirname,__filename,process,global){var _=require("lodash");var util=require("util");var utils=require("../utils");var EventEmitter=require("events").EventEmitter;var Message=require("./message");module.exports=Radio;function Radio(portal){EventEmitter.call(this);this.portal=portal}util.inherits(Radio,EventEmitter);Radio.prototype._router=function(routingkey){var parts=[this.portal.router.shallow()];if(routingkey){parts.push(routingkey)}return parts.join(".")};Radio.prototype.close=function(){this.portal.close();return this};Radio.prototype.listen=function(routingkey,fn){var self=this;if(!fn){fn=routingkey;routingkey=""}if(_.isFunction(fn)){if(routingkey!=""){var origfn=fn;fn=function(message){origfn(message.data)}}else{var origfn=fn;fn=function(message){origfn(message.data,message.route)}}this.portal._prependlisten("radio:/",this._router(routingkey),fn)}else if(_.isObject(fn)){_.each(fn,function(f,routingkey){self.listen(routingkey,f)})}return this};Radio.prototype.listenonce=function(routingkey,fn){var self=this;if(!fn){fn=routingkey;routingkey=""}var oldfn=fn;fn=function(){oldfn.apply(oldfn,_.toArray(arguments));self.portal._cancel(routingkey,fn)};self.listen(routingkey,fn);return this};Radio.prototype.talk=function(routingkey,data){if(!data){data=routingkey;routingkey=""}this.portal._prependbroadcast("radio:/",this._router(routingkey),{route:routingkey,data:data});return this}});require.define("/lib/container/browser.js",function(require,module,exports,__dirname,__filename,process,global){var _=require("lodash");var async=require("async");var EventEmitter=require("events").EventEmitter;var Router=require("./router");module.exports=function(Proto){var factory=Proto.factory;return function(containerconfig){var socket=io.connect([containerconfig.protocol,containerconfig.hostname,"/",containerconfig.socketid].join(""));var subscriptions={};socket.on("connect",function(){announceready()});socket.on("broadcast",function(routingkey,message){console.log("-------------------------------------------");console.log("SOCKET broadcast!!!");var fns=subscriptions[routingkey];_.each(fns,function(fn){fn(message)})});var switchboard={listen:function(routing_key,fn){if(!fn){fn=routing_key;routing_key="*"}console.dir("portal listen : "+routing_key);if(!subscriptions[routing_key]){subscriptions[routing_key]=[];socket.emit("subscription",routing_key)}subscriptions[routing_key].push(fn);return this},cancel:function(routing_key,fn){console.dir("portal cancel : "+routing_key);if(fn){subscriptions[routing_key]=_.filter(subscriptions[routing_key],function(fn){return fn!==fn});if(_.keys(subscriptions[routing_key]).length<=0){delete subscriptions[routing_key];socket.emit("cancelsubscription",routing_key)}}else{delete subscriptions[routing_key];socket.emit("cancelsubscription",routing_key)}return this},broadcast:function(routing_key,packet){console.dir("portal broadcast : "+routing_key);socket.emit("broadcast",{routing_key:routing_key,packet:packet});return this}};_.extend(switchboard,EventEmitter.prototype);var readycallbacks=[];var isready=false;function announceready(){isready=true;async.forEach(readycallbacks,function(callback,next){callback();next()},function(){});readycallbacks=[]}function supplychain(req,res,next){if(!isready){readycallbacks.push(function(){supplychain(req,res,next)
});return}socket.emit("request",req.routingpacket(),req.toJSON(),function(response){res.update(response);res.send()})}supplychain.switchboard=switchboard;function getcontainer(connectpath){return Proto.connect(supplychain,connectpath)}function getuser(data){var retcontainer=Proto.factory([data]);retcontainer.supplychain=supplychain;return retcontainer}var container=getcontainer();container.user=containerconfig.user?getuser(containerconfig.user):factory([]);return container}}});